<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0", viewport-fit=cover"/>
    <title>Virtual Chartered Accountants</title>
    <meta name="description" content="Aapka personal Virtual Chartered Accountant. GST, Income Tax, finance, aur investments se jude sawaal puchein aur turant jawaab paayein.">
    <meta name="keywords" content="Virtual Chartered Accountant, CA Chatbot, GST Expert, Tax Consultant, Income Tax India, Financial Advisor">
     <!-- Allow indexing and link following (default behavior) -->
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="Virtual Chartered Accountants">
    <meta property="og:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein.">
    <meta property="og:image" content="https://ca-app-eta.vercel.app/whatsapp.png"> 
     <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Virtual Chartered Accountant">
    <meta property="og:url" content="https://ca-app-eta.vercel.app"> 
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Virtual Chartered Accountants">
    <meta name="twitter:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein.">
    <meta name="twitter:image" content="https://ca-app-eta.vercel.app/whatsapp.png">     
    
       <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMZ77HZPFR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMZ77HZPFR');
</script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fix for browser viewport - ensure proper height calculation */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        #root {
            height: 100vh;
            height: 100dvh; /* Use dynamic viewport height for better mobile support */
        }
        
        /* Custom classes for fixed header layout */
        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
        
        .chat-content {
            flex: 1;
            overflow-y: auto;
            margin-top: 72px; /* Header height compensation */
        }
        
        .chat-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
        }
        
        /* Ensure proper scrolling in message area only */
        .message-container {
            height: calc(100vh - 144px); /* Full height minus header and footer */
            height: calc(100dvh - 144px);
            overflow-y: auto;
            margin-top: 72px; /* Add top margin to account for fixed header */
            margin-bottom: 72px; /* Add bottom margin to account for fixed footer */
        }
    </style>
    
<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Virtual Chartered Accountants",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "description": "An AI-powered chatbot for Chartered Accountants in India to get expert advice on GST, Income Tax, and Auditing. Saves time by analyzing documents and providing real-time updates.",
      "developer": {
        "@type": "Person",
        "name": "Sumit Garg"
      },
      "offers": {
        "@type": "Offer",
        "price": "0" 
      }
    }
    </script>

    <!-- IndexedDB Utils (Waise hi rahega) -->
    <script src="js/indexeddb-utils.js"></script>
    
    <!-- Google API aur Drive Logic (Waise hi rahega) -->
    <script>
        // Global variable to track authentication status
        let isAuthenticated = false;

    // === STEP 5.1: GOOGLE DRIVE HELPER FUNCTIONS ===
    // === FINAL GOOGLE DRIVE HELPER FUNCTIONS (WITH ALERTS) ===
    const googleDriveService = {
        async findOrCreateFolder(folderName, parentId = null) {
            const parentQuery = parentId ? `'${parentId}' in parents` : "'root' in parents";
            try {
                const response = await gapi.client.drive.files.list({
                    q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and ${parentQuery} and trashed=false`,
                    fields: 'files(id, name)',
                });
                if (response.result.files.length > 0) {
                    console.log(`Folder '${folderName}' found with ID: ${response.result.files[0].id}`);
                    return response.result.files[0].id;
                } else {
                    console.log(`Folder '${folderName}' not found, creating new one...`);
                    const fileMetadata = { name: folderName, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : ['root'] };
                    const newFolderResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                    console.log(`Folder created with ID: ${newFolderResponse.result.id}`);
                    return newFolderResponse.result.id;
                }
            } catch (error) {
                console.error("Error finding or creating folder:", error);
                let errorMessage = "An unknown error occurred. Check console for details.";
                if (error && error.body) { try { const errorDetails = JSON.parse(error.body); if (errorDetails.error && errorDetails.error.message) { errorMessage = errorDetails.error.message; } } catch (e) { errorMessage = "Could not read the exact error message from Google."; } }
                alert("Google Drive Error: " + errorMessage);
                return null;
            }
        },
        async findFileByName(fileName, parentId) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${parentId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    pageSize: 1
                });
                return response.result.files.length > 0 ? response.result.files[0].id : null;
            } catch (error) { console.error("Error finding file:", error); return null; }
        },
        async deleteFile(fileId) {
            try {
                await gapi.client.drive.files.delete({ fileId: fileId });
                console.log(`File with ID ${fileId} deleted successfully.`);
                return true;
            } catch (error) { console.error("Error deleting file:", error); return false; }
        },
        async uploadJsonFile(fileName, jsonData, parentId) {
            try {
                const fileContent = JSON.stringify(jsonData, null, 2);
                const metadata = {
                    name: fileName,
                    parents: [parentId]
                };
                const boundary = '-------314159265358979323846';
                const delimiter = `\r\n--${boundary}\r\n`;
                const close_delim = `\r\n--${boundary}--`;
                const multipartRequestBody =
                    delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata) +
                    delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
                const token = gapi.client.getToken();
                if (!token) {
                    console.error("Authentication token not found!");
                    return null;
                }
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token.access_token}`,
                        'Content-Type': `multipart/related; boundary=${boundary}`
                    },
                    body: multipartRequestBody
                });
                if (!response.ok) {
                    const errorResponse = await response.json();
                    throw new Error(JSON.stringify(errorResponse));
                }
                const result = await response.json();
                console.log(`File '${fileName}' uploaded successfully with ID: ${result.id}`);
                return result.id;
            } catch (error) {
                console.error("Error uploading file with fetch:", error);
                alert("Google Drive UPLOAD Error: " + error.message);
                return null;
            }
        },
        async updateJsonFile(fileId, jsonData) {
            try {
                const fileContent = JSON.stringify(jsonData, null, 2);
                const token = gapi.client.getToken();
                if (!token) {
                    console.error("Authentication token not found!");
                    return null;
                }
                const accessToken = token.access_token;
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: fileContent
                });
                if (!response.ok) {
                    const errorResponse = await response.json();
                    throw new Error(JSON.stringify(errorResponse));
                }
                const result = await response.json();
                console.log(`File with ID ${fileId} updated successfully via fetch.`);
                return result.id;
            } catch (error) {
                console.error("Error updating file with fetch:", error);
                alert("Google Drive UPDATE Error: " + error.message);
                return null;
            }
        },
        async getFileContent(fileId) {
            try {
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                return response.result;
            } catch (error) {
                console.error("Error getting file content:", error);
                return null;
            }
        }
    };
    </script>

    <script>
        // Apni Keys yahan paste karein
        const GOOGLE_CLIENT_ID = '552980243748-g02kbg67f1r8ortovgh7ia975f46a8i6.apps.googleusercontent.com';
    
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Jab GAPI script (Drive ke liye) load ho
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Jab GIS script (Login ke liye) load ho
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive',
                callback: '', // Isko khaali chhod dein, hum iska istemal baad mein karenge
            });
            gisInited = true;
            console.log("âœ… Google Identity Services (GIS) Initialized!");
            checkAndSignalReady();
        }

        // GAPI client ko initialize karna
            async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            });
            gapiInited = true;
            console.log("âœ… Google API Client Initialized!");
            checkAndSignalReady();
        }

        
        // Dono library ready hone par React app ko signal bhejna
        function checkAndSignalReady() {
            if (gapiInited && gisInited) {
                console.log("ðŸš€ Both Google libraries are ready!");
                window.dispatchEvent(new CustomEvent('gapi-ready'));
            }
        }

        // Global variable to store auth token
        let gapiAccessToken = null;

        // Initialize auth token from IndexedDB
        (async () => {
            try {
                gapiAccessToken = await window.chatbotStorage.getAuthToken();
                if (gapiAccessToken) {
                    console.log("ðŸ”‘ Found existing Google Auth Token in IndexedDB.");
                    
                    window.addEventListener('gapi-ready', () => {
                        gapi.client.setToken(gapiAccessToken); 
                        console.log("ðŸš€ Existing token has been set in GAPI client.");
                        window.dispatchEvent(new CustomEvent('google-authed')); 
                    });
                }
            } catch (error) {
                console.error("Error loading auth token:", error);
            }
        })();

        // Login button click hone par yeh chalega
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                gapiAccessToken = resp;
                gapi.client.setToken(gapiAccessToken); 
                
                await window.chatbotStorage.setAuthToken(gapiAccessToken); 
                console.log("âœ… Google Sign-In Successful! Token saved and set in GAPI client.", gapiAccessToken);
                
                window.dispatchEvent(new CustomEvent('google-authed'));
            };

            if (gapiAccessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                google.accounts.oauth2.revoke(gapiAccessToken.access_token);
                gapiAccessToken = null;
                gapi.client.setToken(null); 

                window.chatbotStorage.removeAuthToken(); // IndexedDB se token ko delete karo
                
                console.log("ðŸ”Œ Google Sign-Out Successful! Token removed from IndexedDB.");
                
                window.dispatchEvent(new CustomEvent('google-signed-out'));
            }
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <!-- External libraries (Waise hi rahenge) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script>
    
    <!-- 
      Yahaan se <script type="importmap">...<script> aur
      <script type="text/babel">...</script> HATA DIYE GAYE HAIN.
    -->
    
</head>
<body class="bg-gray-200">
    <!-- HTML root (Waise hi rahega) -->
    <div id="root"></div>
    
    <!-- 
      Yeh hamari nayi, obfuscated file hai jo Webpack banayega.
      Yeh saare React code ko include karegi.
    -->
    <script src="bundle.js" defer></script>
</body>
</html>
