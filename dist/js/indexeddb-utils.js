const DB_NAME="VirtualCADB",DB_VERSION=3;class ChatbotStorage{constructor(){this.dbName=DB_NAME,this.version=3,this.db=null}async openDB(){return this.db?this.db:new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=t=>e("Database error: "+t.target.errorCode),s.onsuccess=e=>{this.db=e.target.result,t(this.db)},s.onupgradeneeded=t=>{const e=t.target.result;["userProfile","characters","groups","authTokens","secretCode","updateCards","tasks"].forEach(t=>{e.objectStoreNames.contains(t)||e.createObjectStore(t,{keyPath:"id"})})}})}async performTransaction(t,e,s){const a=await this.openDB();return new Promise((r,o)=>{const n=a.transaction(t,e),i=n.objectStore(t);n.oncomplete=()=>r(),n.onerror=t=>o(t.target.error),s(i,r,o)})}async getItem(t,e){const s=(await this.openDB()).transaction(t,"readonly").objectStore(t).get(e);return new Promise((t,e)=>{s.onsuccess=()=>t(s.result||null),s.onerror=()=>e(s.error)})}async setItem(t,e){await this.performTransaction(t,"readwrite",(t,s)=>{const a=t.put(e);a.onsuccess=()=>s(a.result)})}async setItems(t,e){await this.performTransaction(t,"readwrite",async(t,s)=>{if(await new Promise((e,s)=>{const a=t.clear();a.onsuccess=e,a.onerror=s}),Array.isArray(e))for(const s of e)t.put(s);s()})}async getAllItems(t){const e=(await this.openDB()).transaction(t,"readonly").objectStore(t).getAll();return new Promise((t,s)=>{e.onsuccess=()=>t(e.result||[]),e.onerror=()=>s(e.error)})}async getUserProfile(){return await this.getItem("userProfile","mainUser")}async setUserProfile(t){await this.setItem("userProfile",{...t,id:"mainUser"})}async getCharacters(){return this.getAllItems("characters")}async setCharacters(t){await this.setItems("characters",t)}async getGroups(){return this.getAllItems("groups")}async setGroups(t){await this.setItems("groups",t)}async getUpdateCards(){return this.getAllItems("updateCards")}async setUpdateCards(t){await this.setItems("updateCards",t)}async getTasks(){return this.getAllItems("tasks")}async setTasks(t){await this.setItems("tasks",t)}async getAuthToken(){const t=await this.getItem("authTokens","googleAuth");return t?t.token:null}async setAuthToken(t){await this.setItem("authTokens",{id:"googleAuth",token:t})}async removeAuthToken(){await this.performTransaction("authTokens","readwrite",(t,e)=>{t.delete("googleAuth").onsuccess=e})}async getSecretCode(){const t=await this.getItem("secretCode","appSecret");return t?t.code:null}async setSecretCode(t){await this.setItem("secretCode",{id:"appSecret",code:t})}async removeSecretCode(){await this.performTransaction("secretCode","readwrite",(t,e)=>{t.delete("appSecret").onsuccess=e})}async getAllData(){const t=await this.getUserProfile(),e=await this.getCharacters(),s=await this.getGroups(),a=await this.getUpdateCards();return await this.getTasks(),{userProfile:t,characters:e,groups:s,updateCards:a}}async setAllData(t){t.userProfile&&await this.setUserProfile(t.userProfile),t.characters&&await this.setCharacters(t.characters),t.groups&&await this.setGroups(t.groups),t.updateCards&&await this.setUpdateCards(t.updateCards),t.tasks&&await this.setTasks(t.tasks)}}window.chatbotStorage=new ChatbotStorage,console.log("ðŸ“¦ IndexedDB storage initialized (v3) for Virtual Chartered Accountants app");