<!DOCTYPE html> 
<html lang="en">
<head>
 <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0", viewport-fit=cover"/><title>Virtual Chartered Accountants</title><meta name="description" content="Aapka personal Virtual Chartered Accountant. GST, Income Tax, finance, aur investments se jude sawaal puchein aur turant jawaab paayein."><meta name="keywords" content="Virtual Chartered Accountant, CA Chatbot, GST Expert, Tax Consultant, Income Tax India, Financial Advisor"><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow"><meta property="og:title" content="Virtual Chartered Accountants"><meta property="og:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein."><meta property="og:image" content="https://ca-app-eta.vercel.app/whatsapp.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:alt" content="Virtual Chartered Accountant"><meta property="og:url" content="https://ca-app-eta.vercel.app"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Virtual Chartered Accountants"><meta name="twitter:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein."><meta name="twitter:image" content="https://ca-app-eta.vercel.app/whatsapp.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-KMZ77HZPFR"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMZ77HZPFR');
</script><script src="https://cdn.tailwindcss.com"></script><style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #root {
            height: 100vh;
            height: 100dvh;
        }
        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
        .chat-content {
            flex: 1;
            overflow-y: auto;
            margin-top: 72px;
        }
        .chat-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
        }
        .message-container {
            height: calc(100vh - 144px);
            height: calc(100dvh - 144px);
            overflow-y: auto;
            margin-top: 72px;
            margin-bottom: 72px;
        }
    </style><script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Virtual Chartered Accountants",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "description": "An AI-powered chatbot for Chartered Accountants in India to get expert advice on GST, Income Tax, and Auditing. Saves time by analyzing documents and providing real-time updates.",
      "developer": {
        "@type": "Person",
        "name": "Sumit Garg"
      },
      "offers": {
        "@type": "Offer",
        "price": "0" 
      }
    }
    </script><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script><script src="js/indexeddb-utils.js"></script><script>
        let isAuthenticated = false;

const googleDriveService = {
    async findOrCreateFolder(_a1, _a2 = null) {
        const _b1 = _a2 ? `'${_a2}' in parents` : "'root' in parents";
        try {
            const _c1 = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${_a1}' and ${_b1} and trashed=false`,
                fields: 'files(id, name)',
            });
            if (_c1.result.files.length > 0) {
                console.log(`Folder '${_a1}' found with ID: ${_c1.result.files[0].id}`);
                return _c1.result.files[0].id;
            } else {
                console.log(`Folder '${_a1}' not found, creating new one...`);
                const _d1 = { name: _a1, mimeType: 'application/vnd.google-apps.folder', parents: _a2 ? [_a2] : ['root'] };
                const _e1 = await gapi.client.drive.files.create({ resource: _d1, fields: 'id' });
                console.log(`Folder created with ID: ${_e1.result.id}`);
                return _e1.result.id;
            }
        } catch (_f1) {
            console.error("Error finding or creating folder:", _f1);
            let _g1 = "An unknown error occurred. Check console for details.";
            if (_f1 && _f1.body) { try { const _h1 = JSON.parse(_f1.body); if (_h1.error && _h1.error.message) { _g1 = _h1.error.message; } } catch (_i1) { _g1 = "Could not read the exact error message from Google."; } }
            alert("Google Drive Error: " + _g1);
            return null;
        }
    },
    async findFileByName(_j1, _k1) {
        try {
            const _l1 = await gapi.client.drive.files.list({
                q: `name='${_j1}' and '${_k1}' in parents and trashed=false`,
                fields: 'files(id, name)',
                pageSize: 1
            });
            return _l1.result.files.length > 0 ? _l1.result.files[0].id : null;
        } catch (_m1) { console.error("Error finding file:", _m1); return null; }
    },
    async deleteFile(_n1) {
        try {
            await gapi.client.drive.files.delete({ fileId: _n1 });
            console.log(`File with ID ${_n1} deleted successfully.`);
            return true;
        } catch (_o1) { console.error("Error deleting file:", _o1); return false; }
    },
    async uploadJsonFile(_p1, _q1, _r1) {
        try {
            const _s1 = JSON.stringify(_q1, null, 2);
            const _t1 = {
                name: _p1,
                parents: [_r1]
            };
            const _u1 = '-------314159265358979323846';
            const _v1 = `\r\n--${_u1}\r\n`;
            const _w1 = `\r\n--${_u1}--`;
            const _x1 =
                _v1 + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(_t1) +
                _v1 + 'Content-Type: application/json\r\n\r\n' + _s1 + _w1;
            const _y1 = gapi.client.getToken();
            if (!_y1) {
                console.error("Authentication token not found!");
                return null;
            }
            const _z1 = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${_y1.access_token}`,
                    'Content-Type': `multipart/related; boundary=${_u1}`
                },
                body: _x1
            });
            if (!_z1.ok) {
                const _a2 = await _z1.json();
                throw new Error(JSON.stringify(_a2));
            }
            const _b2 = await _z1.json();
            console.log(`File '${_p1}' uploaded successfully with ID: ${_b2.id}`);
            return _b2.id;
        } catch (_c2) {
            console.error("Error uploading file with fetch:", _c2);
            alert("Google Drive UPLOAD Error: " + _c2.message);
            return null;
        }
    },
    async updateJsonFile(_d2, _e2) {
        try {
            const _f2 = JSON.stringify(_e2, null, 2);
            const _g2 = gapi.client.getToken();
            if (!_g2) {
                console.error("Authentication token not found!");
                return null;
            }
            const _h2 = _g2.access_token;
            const _i2 = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${_d2}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${_h2}`,
                    'Content-Type': 'application/json'
                },
                body: _f2
            });
            if (!_i2.ok) {
                const _j2 = await _i2.json();
                throw new Error(JSON.stringify(_j2));
            }
            const _k2 = await _i2.json();
            console.log(`File with ID ${_d2} updated successfully via fetch.`);
            return _k2.id;
        } catch (_l2) {
            console.error("Error updating file with fetch:", _l2);
            alert("Google Drive UPDATE Error: " + _l2.message);
            return null;
        }
    },
    async getFileContent(_m2) {
        try {
            const _n2 = await gapi.client.drive.files.get({ fileId: _m2, alt: 'media' });
            return _n2.result;
        } catch (_o2) {
            console.error("Error getting file content:", _o2);
            return null;
        }
    }
};
</script><script>
    const GOOGLE_CLIENT_ID = '552980243748-g02kbg67f1r8ortovgh7ia975f46a8i6.apps.googleusercontent.com';
   

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive',
            callback: '',
        });
        gisInited = true;
        console.log("✅ Google Identity Services (GIS) Initialized!");
        checkAndSignalReady();
    }

        async function initializeGapiClient() {
        await gapi.client.init({
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
        });
        gapiInited = true;
        console.log("✅ Google API Client Initialized!");
        checkAndSignalReady();
    }

    
    function checkAndSignalReady() {
        if (gapiInited && gisInited) {
             console.log("🚀 Both Google libraries are ready!");
             window.dispatchEvent(new CustomEvent('gapi-ready'));
        }
    }

let gapiAccessToken = null;


(async () => {
    try {
        gapiAccessToken = await window.chatbotStorage.getAuthToken();
        if (gapiAccessToken) {
            console.log("🔑 Found existing Google Auth Token in IndexedDB.");
            window.addEventListener('gapi-ready', () => {
                gapi.client.setToken(gapiAccessToken);
                console.log("🚀 Existing token has been set in GAPI client.");
                window.dispatchEvent(new CustomEvent('google-authed')); 
            });
        }
    } catch (error) {
        console.error("Error loading auth token:", error);
    }
})();


function handleAuthClick() {
    tokenClient.callback = async (_p2) => {
        if (_p2.error !== undefined) {
            throw (_p2);
        }
        gapiAccessToken = _p2;
        gapi.client.setToken(gapiAccessToken);
        await window.chatbotStorage.setAuthToken(gapiAccessToken); 
        console.log("✅ Google Sign-In Successful! Token saved and set in GAPI client.", gapiAccessToken);
        window.dispatchEvent(new CustomEvent('google-authed'));
    };

    if (gapiAccessToken === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        google.accounts.oauth2.revoke(gapiAccessToken.access_token);
        gapiAccessToken = null;
        gapi.client.setToken(null);
        window.chatbotStorage.removeAuthToken();
        console.log("🔌 Google Sign-Out Successful! Token removed from IndexedDB.");
        window.dispatchEvent(new CustomEvent('google-signed-out'));
    }
}
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script><script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script><script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.20.0"
  }
}
</script></head>
<body class="bg-gray-200"><div id="root"></div><script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const apiKeyManager = {
  dbName: 'ApiKeyStatusDB',
  storeName: 'deactivated_keys',
  
  async getDB() {
    return new Promise((_p3, _q3) => {
      const _r3 = indexedDB.open(this.dbName, 1);
      _r3.onerror = () => _q3("Error opening DB");
      _r3.onsuccess = () => _p3(_r3.result);
      _r3.onupgradeneeded = _s3 => {
        const _t3 = _s3.target.result;
        _t3.createObjectStore(this.storeName, { keyPath: 'index' });
      };
    });
  },

  async getDeactivatedKeys() {
    const _u3 = await this.getDB();
    return new Promise(_v3 => {
      const _w3 = _u3.transaction(this.storeName, 'readonly');
      const _x3 = _w3.objectStore(this.storeName);
      const _y3 = _x3.getAll();
      _y3.onsuccess = async () => {
        const _z3 = Date.now();
        const _a4 = 24 * 60 * 60 * 1000;
        
        const _b4 = _y3.result.filter(_c4 => (_z3 - _c4.timestamp) > _a4);
        for (const _d4 of _b4) {
          await this.activateKey(_d4.index);
        }

        const _e4 = _y3.result.filter(_f4 => (_z3 - _f4.timestamp) <= _a4);
        _v3(_e4);
      };
    });
  },

  async deactivateKey(_g4) {
    const _h4 = await this.getDB();
    const _i4 = _h4.transaction(this.storeName, 'readwrite');
    const _j4 = _i4.objectStore(this.storeName);
    _j4.put({ index: _g4, timestamp: Date.now() });
  },
  
  async activateKey(_k4) {
      const _l4 = await this.getDB();
      const _m4 = _l4.transaction(this.storeName, 'readwrite');
      const _n4 = _m4.objectStore(this.storeName);
      _n4.delete(_k4);
  }
};

        let currentKeyIndex = 0;

        const MessageSender = {
            USER: 'user',
            AI: 'ai',
        };

        const ActLike = {
            FRIEND: 'Friend',
            PROFESSIONAL: 'Professional',
        };

        const Expert = {
            TAX_CONSULTANT: 'Tax Consultant',
            GST_EXPERT: 'GST Expert',
            STATUTORY_AUDITOR: 'Statutory Auditor',
            INTERNAL_AUDITOR: 'Internal Auditor',
            INVESTMENT_ADVISOR: 'Investment Advisor',
            FINANCIAL_PLANNER: 'Financial Planner',
            CORPORATE_ADVISOR: 'Corporate Advisor',
            BANKING_EXPERT: 'Banking Expert',
            INSURANCE_ADVISOR: 'Insurance Advisor',
            MUTUAL_FUND_EXPERT: 'Mutual Fund Expert',
            COMPANY_SECRETARY: 'Company Secretary',
            COST_ACCOUNTANT: 'Cost Accountant',
            FORENSIC_ACCOUNTANT: 'Forensic Accountant',
            TRANSFER_PRICING_EXPERT: 'Transfer Pricing Expert',
            IFRS_SPECIALIST: 'IFRS Specialist',
            VALUATION_EXPERT: 'Valuation Expert',
            COMPLIANCE_OFFICER: 'Compliance Officer',
            RISK_MANAGEMENT_EXPERT: 'Risk Management Expert',
            TREASURY_MANAGEMENT: 'Treasury Management',
            EXPERT_ALL_FIELDS: 'Expert in All Fields',
        };

        const Gender = {
            MALE: 'Male',
            FEMALE: 'Female',
            OTHER: 'Other',
        };

        const ChatType = {
            SINGLE: 'single',
            GROUP: 'group',
        };
        
        const _f5 = (_g5, _h5, _i5 = 300000) => {
          let _j5;
          return () => {
            clearTimeout(_j5);
            _j5 = setTimeout(async () => {
              try {
                if (_g5 === 'userProfile') {
                  await window.chatbotStorage.setUserProfile(_h5);
                } else if (_g5 === 'characters') {
                  await window.chatbotStorage.setCharacters(_h5);
                } else if (_g5 === 'groups') {
                  await window.chatbotStorage.setGroups(_h5);
                }
                console.log(`Saved ${_g5} after ${_i5 / 1000 / 60} min idle to IndexedDB.`);
              } catch (_k5) {
                console.error(`Save failed for ${_g5}:`, _k5);
              }
            }, _i5);
          };
        };

        const _l5 = (_m5) => /tax|slab|income|fy \d{2}-\d{2}/i.test(_m5.toLowerCase());

        const DEFAULT_AVATARS = {
            'Male': [
                '01_CABOY.png',
                '02_CABOY.jpg'
            ],
            'Female': [
                '01_CAGIRL.png',
                '02_CAGIRL.png'
            ],
            'Other': []
        };

        const _n5 = (_o5) => {
          return _o5.map(_p5 => ({
            role: _p5.sender === MessageSender.USER ? 'user' : 'model',
            parts: [{ text: _p5.text }]
          }));
        };

const generateChatResponseStream = async (_q5, _r5, _s5, _t5, _u5, onBlock, keyIndex) => {         
               const _v5 = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            history: _n5(_s5.slice(0, -1)),
            message: _t5.text,
            keyIndex: keyIndex,
            chatType: 'single',
            character: _q5,
            userProfile: _r5
        }),
    });
    return _v5;
};

const generateGroupChatResponseStream = async (_w5, _x5, _y5, _z5, _a6, _b6, onBlock, keyIndex) => {
    const _c6 = _y5.slice(0, -1).map(_d6 => {
        const _e6 = _d6.sender === 'user' ? _x5.name : _w5.find(_f6 => _f6.id === _d6.sender)?.name || 'Unknown';
        return { role: 'user', parts: [{ text: `${_e6}: ${_d6.text}` }] };
    });
    
    const _g6 = _z5.text.startsWith('[System:') 
        ? _z5.text 
        : `User: ${_z5.text}\n\nContinue the group conversation following the rules and format exactly.`;
    
    const _h6 = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            history: _c6,
            message: _g6,
            keyIndex: keyIndex,
            chatType: 'group',
            userProfile: _x5,
            groupMembers: _w5,
            consecutiveSkips: _b6
        }),
    });

    return _h6;
};

        const UserProfileSetup = ({ userProfile: _i6, onSave: _j6, onCancel: _k6, isInitialSetup: _l6 = false }) => {
          const [_m6, _n6] = useState({
              ..._i6,
              name: _i6.name || 'Alex',
              age: _i6.age || 25,
              gender: _i6.gender || Gender.MALE
          });

          const _o6 = (_p6) => {
            if (_p6.target.files && _p6.target.files[0]) {
              const _q6 = _p6.target.files[0];
              const _r6 = new FileReader();
              _r6.onload = (_s6) => {
                if (_s6.target && typeof _s6.target.result === 'string') {
                  _n6(_t6 => ({ ..._t6, avatar: _s6.target.result }));
                }
              };
              _r6.readAsDataURL(_q6);
            }
          };
          
          const _u6 = (_v6) => {
            _v6.preventDefault();
            if (!_m6.name) {
                alert("Please enter your name.");
                return;
            }
            _j6(_m6);
          };
          
          return (
            <div className="flex flex-col h-full bg-blue-50">
                <header className="bg-blue-600 text-white p-4 pt-8 text-center">
                    <h1 className="text-2xl font-bold">Virtual Chartered Accountants</h1>
                    <p className="text-sm opacity-90">First, let's set up your profile.</p>
                </header>
                <main className="flex-grow bg-white rounded-t-2xl p-4 overflow-y-auto">
                    <form onSubmit={_u6} className="p-6 space-y-4">
                      <h2 className="text-xl font-bold text-center text-gray-700">Your Profile</h2>
                      <div className="flex flex-col items-center space-y-2">
                        <img
                          src={_m6.avatar || `https://i.pravatar.cc/150?u=${_m6.id}`}
                          alt="Your avatar"
                          className="w-24 h-24 rounded-full object-cover border-2 border-gray-300"
                        />
                        <label className="cursor-pointer text-sm text-blue-600 hover:underline">
                          Change Picture
                          <input type="file" accept="image/*" onChange={_o6} className="hidden" />
                        </label>
                      </div>
                        <div>
                        <label className="block text-sm font-medium text-gray-700 text-center">Or select a default avatar:</label>
                        <div className="mt-2 flex flex-wrap justify-center gap-2">
                            {[...DEFAULT_AVATARS['Male'], ...DEFAULT_AVATARS['Female'], ...DEFAULT_AVATARS['Other']].map((_w6, _x6) => (
                                <img
                                    key={_x6}
                                    src={_w6}
                                    alt={`Avatar ${_x6 + 1}`}
                                    className={`w-16 h-16 rounded-full object-cover cursor-pointer border-4 ${_m6.avatar === _w6 ? 'border-blue-600' : 'border-gray-200'}`}
                                    onClick={() => _n6(_y6 => ({ ..._y6, avatar: _w6 }))}
                                />
                            ))}
                        </div>
                      </div>

                        
                       <div>
                        <label className="block text-sm font-medium text-gray-700">Your Name *</label>
                        <input
                          type="text"
                          value={_m6.name}
                          onChange={_z6 => _n6({ ..._m6, name: _z6.target.value })}
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Alex"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Age (Optional)</label>
                        <input
                          type="number"
                          value={_m6.age || ''}
                          onChange={_a7 => _n6({ ..._m6, age: parseInt(_a7.target.value) || null })}
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="25"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Gender</label>
                        <select
                          value={_m6.gender || ''}
                          onChange={_b7 => _n6({ ..._m6, gender: _b7.target.value })}
                           className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="">Select Gender (Optional)</option>
                            {Object.values(Gender).map(_c7 => <option key={_c7} value={_c7}>{_c7}</option>)}
                        </select>
                      </div>
                      <div className="flex justify-end space-x-2 pt-4">
                        {!_l6 && (
                            <button 
                                type="button" 
                                onClick={_k6} 
                                className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                        )}
                        <button 
                            type="submit" 
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            {_l6 ? "Save Profile" : "Save Profile"}
                        </button>
                      </div>
                    </form>
                </main>
            </div>
          )
        }

const FileIcon = ({ fileType: _d7 }) => {
    let _e7 = <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" />;
    if (_d7.includes('pdf')) {
        _e7 = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4zm2 2a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0V7a1 1 0 00-1-1zm-6 5a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clipRule="evenodd" />;
    } else if (_d7.includes('spreadsheet') || _d7.includes('excel') || _d7.includes('csv')) {
        _e7 = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm0 4h10v2H5V8zm0 4h10v2H5v-2z" clipRule="evenodd" />;
    } else if (_d7.includes('word')) {
        _e7 = <path fillRule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm0 4h10v2H5V8zm0 4h10v2H5v-2z" clipRule="evenodd" />;
    }
    return (
        <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
            {_e7}
        </svg>
    );
};

      const MessageInput = ({ onSend: _f7, onSkip: _g7, isBlocked: _h7 }) => {
    const [_i7, _j7] = useState('');
    const [_k7, _l7] = useState([]);
    const _m7 = useRef(null);

    const _n7 = () => {
        const _o7 = _k7.filter(_p7 => _p7.status === 'ready');
        if (_i7.trim() || _o7.length > 0) {
            _f7(_i7.trim(), _o7);
            _j7('');
            _l7([]);
        }
    };

    const _q7 = (_r7) => {
        const _s7 = Array.from(_r7.target.files);
        const _t7 = [
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'text/csv', 'text/plain', 'application/json', 'text/html',
            'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
        ];

        const _u7 = _s7.filter(_v7 => {
            const _w7 = _t7.includes(_v7.type) ||
                _v7.name.toLowerCase().match(/\.(xlsx?|csv|txt|json|html?|pdf|docx?|jpe?g|png|gif|webp)$/i);
            if (!_w7) {
                alert(`File "${_v7.name}" is not supported.`);
            }
            return _w7 && _v7.size <= 50 * 1024 * 1024;
        });

        if (_u7.length > 0) {
            const _x7 = _u7.map(_y7 => {
                const _z7 = Date.now() + Math.random();
                _l7(_a8 => [..._a8, {
                    id: _z7,
                    name: _y7.name,
                    size: _y7.size,
                    type: _y7.type,
                    status: 'reading',
                    preview: null
                }]);
                return { file: _y7, fileId: _z7 };
            });

            _x7.forEach(({ file: _b8, fileId: _c8 }) => {
                const _d8 = new Promise((_e8, _f8) => {
                    const _g8 = new FileReader();
                    const _h8 = _b8.name.toLowerCase().match(/\.(xlsx?)$/i);
                    const _i8 = _b8.type === 'application/pdf';
                    const _j8 = _b8.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || _b8.name.toLowerCase().endsWith('.docx');
                    const _k8 = _b8.type.startsWith('image/');
    
                  if (_h8) {
                        _g8.onload = (_l8) => {
                           try {
                                const _m8 = XLSX.read(new Uint8Array(_l8.target.result), { type: 'array' });
                                let _n8 = '';

                                _m8.SheetNames.forEach(_o8 => {
                                    _n8 += `\n\n--- Sheet: ${_o8} ---\n\n`;
                                    const _p8 = _m8.Sheets[_o8];
                                    const _q8 = XLSX.utils.sheet_to_csv(_p8);
                                    _n8 += _q8;
                                });
                                
                                _e8({ content: _n8, type: 'text/csv' });

                           } catch (_r8) { _f8(_r8); }
                        };
                        _g8.readAsArrayBuffer(_b8);
                    } 
                    
                    else if (_i8) {
                       _g8.onload = async (_s8) => {
                           try {
                               const _t8 = await pdfjsLib.getDocument({ data: new Uint8Array(_s8.target.result) }).promise;
                               let _u8 = '';
                               for (let _v8 = 1; _v8 <= _t8.numPages; _v8++) {
                                   const _w8 = await _t8.getPage(_v8);
                                   const _x8 = await _w8.getTextContent();
                                   _u8 += _x8.items.map(_y8 => _y8.str).join(' ') + '\n';
                               }
                               _e8({ content: _u8, type: _b8.type });
                           } catch (_z8) { _f8(_z8); }
                       };
                       _g8.readAsArrayBuffer(_b8);
                    } else if (_j8) {
                        _g8.onload = async (_a9) => {
                           try {
                               const _b9 = await mammoth.extractRawText({ arrayBuffer: _a9.target.result });
                               _e8({ content: _b9.value, type: _b8.type });
                           } catch (_c9) { _f8(_c9); }
                        };
                        _g8.readAsArrayBuffer(_b8);
                    } else if (_k8) {
                        _g8.onload = async (_d9) => {
                           try {
                               const _e9 = await Tesseract.recognize(_d9.target.result, 'eng');
                               _e8({ content: _e9.data.text, preview: _d9.target.result });
                           } catch (_f9) { _f8(_f9); }
                        };
                        _g8.readAsDataURL(_b8);
                    } else {
                        _g8.onload = (_g9) => _e8({ content: _g9.target.result, type: _b8.type });
                        _g8.readAsText(_b8);
                    }
                });

                _d8.then(_h9 => {
                    _l7(_i9 => _i9.map(_j9 =>
                        _j9.id === _c8 ? { ..._j9, status: 'ready', content: _h9.content, preview: _h9.preview || _j9.preview, type: _h9.type || _j9.type } : _j9
                    ));
                }).catch(_k9 => {
                    console.error('Error reading file:', _b8.name, _k9);
                    _l7(_l9 => _l9.map(_m9 =>
                        _m9.id === _c8 ? { ..._m9, status: 'error' } : _m9
                    ));
                });
            });
        }
        _r7.target.value = '';
    };

    const _n9 = (_o9) => {
        _l7(_p9 => _p9.filter(_q9 => _q9.id !== _o9));
    };

    const _r9 = (_s9) => {
        if (_s9 === 0) return '0 Bytes';
        const _t9 = 1024;
        const _u9 = ['Bytes', 'KB', 'MB', 'GB'];
        const _v9 = Math.floor(Math.log(_s9) / Math.log(_t9));
        return parseFloat((_s9 / Math.pow(_t9, _v9)).toFixed(2)) + ' ' + _u9[_v9];
    };

    return (
        <footer className="chat-footer bg-white border-t border-gray-300">
            {_k7.length > 0 && (
                <div className="p-3 border-b border-gray-200 bg-gray-50">
                    <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                        {_k7.map(_w9 => (
                            <div key={_w9.id} className="relative bg-white border border-gray-300 rounded-lg p-2 flex items-center gap-2 max-w-xs">
                                {_w9.preview ? (
                                    <img src={_w9.preview} alt={_w9.name} className="w-8 h-8 object-cover rounded" />
                                ) : (
                                    <div className={`w-8 h-8 rounded flex items-center justify-center ${_w9.status === 'error' ? 'bg-red-500' : 'bg-blue-500'}`}>
                                        <FileIcon fileType={_w9.type} />
                                    </div>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className="text-xs font-medium text-gray-900 truncate">{_w9.name}</div>
                                    <div className="text-xs text-gray-500">{_r9(_w9.size)}</div>
                                </div>
                                
                                <div className="w-5 h-5 flex items-center justify-center">
                                    {_w9.status === 'reading' && (
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                    )}
                                    {_w9.status === 'ready' && (
                                        <svg className="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {_w9.status === 'error' && (
                                        <svg className="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                             <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <button
                                    onClick={() => _n9(_w9.id)}
                                    className="p-1 hover:bg-gray-200 rounded-full transition-colors"
                                >
                                    <svg className="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )}
            
            <div className="p-3 flex items-center gap-3">
                <input
                    type="file"
                    ref={_m7}
                    onChange={_q7}
                    multiple
                    accept=".xlsx,.xls,.csv,.txt,.json,.html,.htm,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp"
                    className="hidden"
                />
                <button
                    onClick={() => _m7.current?.click()}
                    className="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                    disabled={_h7}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                </button>
                <div className="flex-grow">
                    <input
                        type="text"
                        value={_i7}
                        onChange={_x9 => _j7(_x9.target.value)}
                        onKeyPress={_y9 => _y9.key === 'Enter' && _n7()}
                        placeholder={_h7 ? "You are blocked" : "Message..."}
                        className="w-full px-4 py-3 bg-gray-100 border border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled={_h7}
                    />
                </div>
                {_g7 && (
                    <button onClick={_g7} className="p-2 text-white bg-gray-600 hover:bg-gray-700 rounded-full transition-colors" disabled={_h7}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                )}
                <button
                    onClick={_n7}
                    className={`p-3 text-white rounded-full transition-colors ${
                        (_i7.trim() || _k7.some(_z9 => _z9.status === 'ready')) && !_h7 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'
                    }`}
                    disabled={!(_i7.trim() || _k7.some(_a10 => _a10.status === 'ready')) || _h7}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </footer>
    );
};
        
const _b10 = (_c10) => {
  if (_c10.length < 2) return null;

  const _d10 = _c10[0].split('|').map(_e10 => _e10.trim()).filter(_f10 => _f10);
  
  const _g10 = _c10.slice(2).map(_h10 =>
    _h10.split('|').map(_i10 => _i10.trim()).filter(_j10 => _j10)
  ).filter(_k10 => _k10.length > 0 && _k10.some(_l10 => _l10.length > 0));

  if (_d10.length > 0 && _g10.length > 0) {
    return { headers: _d10, rows: _g10 };
  }
  return null;
};

const _m10 = (_n10) => {
  const _o10 = [];
  const _p10 = _n10.split('\n');
  let _q10 = [];

  for (let _r10 = 0; _r10 < _p10.length; _r10++) {
    const _s10 = _p10[_r10].trim();

    if (_s10.startsWith('|') && _s10.endsWith('|')) {
      if (_q10.length > 0) {
        _o10.push({ type: 'text', content: _q10.join('\n') });
        _q10 = [];
      }

      const _t10 = [];
      while (_r10 < _p10.length && _p10[_r10].trim().startsWith('|') && _p10[_r10].trim().endsWith('|')) {
        _t10.push(_p10[_r10]);
        _r10++;
      }
      _r10--;

      const _u10 = _b10(_t10);
      if (_u10) {
        _o10.push({ type: 'table', data: _u10 });
      } else {
        _q10.push(..._t10);
      }
    } else {
      _q10.push(_p10[_r10]);
    }
  }

  if (_q10.length > 0) {
    _o10.push({ type: 'text', content: _q10.join('\n') });
  }

  return _o10;
};


const DataTable = ({ headers: _v10, rows: _w10 }) => {
  const [_x10, _y10] = React.useState(false);

  const _z10 = () => {
    let _a11 = _v10.join('\t') + '\n';
    _a11 += _w10.map(_b11 => _b11.join('\t')).join('\n');
    
    navigator.clipboard.writeText(_a11).then(() => {
      _y10(true);
      setTimeout(() => _y10(false), 2000);
    });
  };

  return (
    <div className="mt-2 text-sm text-gray-800">
      <div className="overflow-x-auto border border-gray-300 rounded-lg bg-gray-50">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-100">
            <tr>
              {_v10.map((_c11, _d11) => (
                <th key={_d11} className="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  {_c11}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {_w10.map((_e11, _f11) => (
              <tr key={_f11} className={_f11 % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                {_e11.map((_g11, _h11) => (
                  <td key={_h11} className="px-4 py-2 whitespace-nowrap">
                    {_g11}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="flex justify-end mt-2">
        <button
          onClick={_z10}
          className={`fl items-center gap-1 px-3 py-1 text-xs rounded-full transition-colors ${
            _x10 
              ? 'bg-green-100 text-green-700' 
              : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
          }`}
        >
          {_x10 ? 'Copied!' : 'Copy Table'}
        </button>
      </div>
    </div>
  );
};

const MessageBubble = ({ message: _i11, characterProfile: _j11, userProfile: _k11, characters: _l11, onEdit: _m11, onDelete: _n11 }) => {
    const _o11 = _i11.sender === MessageSender.USER;
    const [_p11, _q11] = React.useState(false);
    const [_r11, _s11] = React.useState(_i11.text);
    const [_t11, _u11] = React.useState(false);
    const _v11 = React.useRef(null);

    const _w11 = () => {
        if (_m11) {
            _m11(_i11.id, _r11);
        }
        _q11(false);
    };

    const _x11 = () => {
        _q11(false);
        _s11(_i11.text);
    };

    const _y11 = (_z11) => {
        _z11.preventDefault();
        if (_o11) {
            _u11(true);
        }
    };

    React.useEffect(() => {
        const _a12 = (_b12) => {
            if (_v11.current && !_v11.current.contains(_b12.target)) {
                _u11(false);
            }
        };
        document.addEventListener("mousedown", _a12);
        return () => {
            document.removeEventListener("mousedown", _a12);
        };
    }, [_v11]);

    const _c12 = _o11 ?
        _k11 :
        (_l11 && _l11.find(_d12 => _d12.id === _i11.sender)) || _j11;

    const _e12 = _o11 ? _k11.avatar : _c12?.avatars?.[_c12?.activeAvatarIndex || 0];
    const _f12 = _o11 ? `https://i.pravatar.cc/150?u=${_k11.id}` : `https://i.pravatar.cc/150?u=${_c12?.id}`;
    const _g12 = _o11 ? null : _c12?.name;

    const _h12 = (_i12) => {
        const _j12 = new Date(_i12);
        const _k12 = _j12.getHours().toString().padStart(2, '0');
        const _l12 = _j12.getMinutes().toString().padStart(2, '0');
        return `${_k12}:${_l12}`;
    };

    const _m12 = (_n12) => {
        return _n12.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    };

    const _o12 = _o11 ? [{ type: 'text', content: _i11.text }] : _m10(_i11.text);

    const _p12 = (_q12) => {
        if (!_q12) return '';
        if (_q12 === 0) return '0 Bytes';
        const _r12 = 1024;
        const _s12 = ['Bytes', 'KB', 'MB', 'GB'];
        const _t12 = Math.floor(Math.log(_q12) / Math.log(_r12));
        return parseFloat((_q12 / Math.pow(_r12, _t12)).toFixed(2)) + ' ' + _s12[_t12];
    };

    return (
        <div className={`flex items-end gap-2 mb-1 ${_o11 ? 'justify-end' : 'justify-start'}`}>
            {_c12 && (
                <img
                    src={_e12 || _f12}
                    alt={_o11 ? 'Your avatar' : _c12.name}
                    className="w-8 h-8 rounded-full object-cover flex-shrink-0"
                />
            )}
            <div
                onContextMenu={_y11}
                className={`relative group ${_o12.some(_u12 => _u12.type === 'table') ? 'max-w-full md:max-w-4xl' : 'max-w-sm md:max-w-md'}`}
            >
                <div className={`px-4 py-3 rounded-2xl shadow-lg border ${
                    _o11 ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white border-blue-400' : 'bg-white text-gray-800 border-gray-200 shadow-md'
                }`}>

                    {_i11.attachments && _i11.attachments.length > 0 && (
                        <div className="mb-2 space-y-2">
                            {_i11.attachments.map(_v12 => (
                                <div key={_v12.id} className={`p-2 rounded-lg flex items-center gap-3 ${_o11 ? 'bg-blue-700/50' : 'bg-gray-100'}`}>
                                    {_v12.preview ? (
                                        <img src={_v12.preview} alt={_v12.name} className="w-10 h-10 object-cover rounded-md flex-shrink-0" />
                                    ) : (
                                        <div className={`w-10 h-10 rounded-md flex items-center justify-center flex-shrink-0 ${_o11 ? 'bg-blue-500' : 'bg-gray-500'}`}>
                                            <FileIcon fileType={_v12.type} />
                                        </div>
                                    )}
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-medium truncate ${_o11 ? 'text-white' : 'text-gray-800'}`}>{_v12.name}</p>
                                        <p className={`text-xs ${_o11 ? 'text-blue-100' : 'text-gray-500'}`}>{_p12(_v12.size)}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {_p11 ? (
                        <div className="space-y-2">
                            <textarea
                                value={_r11}
                                onChange={_w12 => _s11(_w12.target.value)}
                                className="w-full p-2 border border-gray-300 rounded text-gray-800 resize-none"
                                rows={3}
                                autoFocus
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={_w11}
                                    className="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                                >
                                    Save
                                </button>
                                <button
                                    onClick={_x11}
                                    className="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <>
                            {_o12.map((_x12, _y12) => {
                                if (_x12.type === 'table') {
                                    return (
                                        <DataTable
                                            key={_y12}
                                            headers={_x12.data.headers}
                                            rows={_x12.data.rows}
                                        />
                                    );
                                } else {
                                    if (_x12.content.trim()) {
                                        return (
                                            <p
                                                key={_y12}
                                                className="whitespace-pre-wrap"
                                                dangerouslySetInnerHTML={{ __html: _m12(_x12.content) }}
                                            />
                                        );
                                    }
                                    return null;
                                }
                            })}
                        </>
                    )}

                    <div className={`flex items-center justify-between mt-1 ${
                        _o11 ? 'text-blue-100' : 'text-gray-500'
                    }`}>
                        {!_o11 && _g12 && <span className="text-xs font-bold">{_g12}</span>}
                        <div className="flex items-center">
                            <span className="text-xs ml-2">{_h12(_i11.timestamp)}</span>
                            {_o11 && (
                                <svg className="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                            )}
                        </div>
                    </div>
                </div>

                {_t11 && _o11 && (
                    <div
                        ref={_v11}
                        className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[120px]"
                    >
                        <button
                            onClick={_z12 => {
                                _z12.stopPropagation();
                                _q11(true);
                                _u11(false);
                            }}
                            className="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            Edit
                        </button>
                        <button
                            onClick={_a13 => {
                                _a13.stopPropagation();
                                if (confirm('Are you sure you want to delete this message?')) {
                                    _n11 && _n11(_i11.id);
                                }
                                _u11(false);
                            }}
                            className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Delete
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

const MessageList = ({ 
    messages: _b13, character: _c13, userProfile: _d13, characters: _e13, isTyping: _f13, backgroundUrl: _g13, 
    streamingText: _h13 = '', onEditMessage: _i13, onDeleteMessage: _j13,
    isBlocked: _k13, blockCount: _l13, handleUnblock: _m13, characterName: _n13, groupName: _o13
}) => {
  const _p13 = useRef(null);
  const _q13 = 'https://i.redd.it/qwd83nc4xxf41.jpg';

  useEffect(() => {
    _p13.current?.scrollIntoView({ behavior: 'smooth' });
  }, [_b13, _f13]);
  
  const _r13 = {
    backgroundImage: `url('${_g13 || _q13}')`,
    backgroundSize: 'cover',
    backgroundPosition: 'center',
  };

  const _s13 = () => {
   return _b13.map(_t13 => (
      <MessageBubble
        key={_t13.id}
        message={_t13}
        characterProfile={_c13}
        userProfile={_d13}
        characters={_e13}
        onEdit={_i13} 
        onDelete={_j13} 
      />
    ));
  };

   return (
    <main className="message-container" style={_r13}>
      
      {_k13 && (
        <div className="sticky top-0 z-10 p-4">
            <div className="text-center p-4 bg-red-100 border border-red-400 text-red-700 rounded-md shadow-lg">
                <p className="font-bold">You are blocked by {_n13 || _o13} 😣</p>
                <p className="text-sm">You have {3 - _l13} unblock attempt(s) remaining.</p>
                <button
                    onClick={_m13}
                    className="mt-2 px-4 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                >
                    Request Unblock
                </button>
            </div>
            </div>
      )}
      
      <div className="space-y-2 p-4">
        {_s13()}
        {_f13 && (
          <div className="flex justify-start items-end gap-2">
            {(_e13 && _e13.length <= 1) && (
              <img src={_c13?.avatars?.[_c13?.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${_c13?.id}`} alt="ai" className="w-8 h-8 rounded-full object-cover" />
            )}
            <div className={`bg-white rounded-2xl p-3 max-w-xs shadow ${(_e13 && _e13.length > 1) ? 'ml-0' : ''}`}>
              <div className="flex items-center justify-center space-x-1">
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-0"></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-150"></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-300"></span>
              </div>
            </div>
           </div>
        )}
        <div ref={_p13} />
      </div>
    </main>
  );
};

        const BackgroundModal = ({ isOpen: _u13, onClose: _v13, onSetBackground: _w13 }) => {
            const _x13 = useRef(null);

            if (!_u13) return null;

            const _y13 = (_z13) => {
                if (_z13.target.files && _z13.target.files[0]) {
                    const _a14 = _z13.target.files[0];
                    const _b14 = new FileReader();
                    _b14.onload = (_c14) => {
                        if (_c14.target && typeof _c14.target.result === 'string') {
                           _w13(_c14.target.result);
                        }
                    };
                    _b14.readAsDataURL(_a14);
                }
                _v13();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">Background Settings</h3>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Upload Background Image</label>
                            <button
                                onClick={() => _x13.current?.click()}
                                className="w-full py-2 px-4 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
                            >
                                Choose file
                            </button>
                            <input
                                type="file"
                                ref={_x13}
                                accept="image/*"
                                onChange={_y13}
                                className="hidden"
                            />
                            <p className="text-xs text-gray-500 mt-1">Max size: 10MB</p>
                        </div>
                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={_v13}
                                className="py-2 px-4 text-gray-600 hover:text-gray-800"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => _x13.current?.click()}
                                className="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            >
                                Save Background
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatHeader = ({ character: _d14, onBack: _e14, onEditAiProfile: _f14, onEditUserProfile: _g14, onClearChat: _h14, onSetBackground: _i14 }) => {
          const [_j14, _k14] = useState(false);

          return (
            <>
                <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                  <button onClick={_e14} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div 
                    className="flex items-center ml-2 cursor-pointer flex-grow"
                    onClick={_f14}
                  >
                    <img
                      src={_d14.avatars[_d14.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${_d14.id}`}
                      alt={_d14.name}
                      className="w-10 h-10 rounded-full object-cover"
                    />
                    <div className="ml-3">
                      <h2 className="font-semibold text-lg">{_d14.name}</h2>
                      <p className="text-sm opacity-90">{_d14.actLike} • {_d14.expertise.includes('Tax Consultant') ? 'Tax Consultant' : _d14.expertise[0] || 'General CA'}</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-1">
                    <button 
                        onClick={() => _k14(true)} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Background"
                    >
                        <span className="text-xl">🎨</span>
                    </button>
                    <button 
                        onClick={_g14} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Profile"
                    >
                        <span className="text-xl">👤</span>
                    </button>
                    <button 
                        onClick={_h14} 
                        className="p-2 rounded-full hover:bg-white/20"
                        title="Clear Chat"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                  </div>
                </header>
                <BackgroundModal
                    isOpen={_j14}
                    onClose={() => _k14(false)}
                    onSetBackground={_i14}
                />
            </>
          );
        };

       const CharacterSetup = ({ initialCharacter: _l14, onSave: _m14, onCancel: _n14 }) => {
          const _o14 = () => {
            const _p14 = _l14.avatars?.length > 0;
            
            const _q14 = _p14
              ? _l14.avatars 
              : [...DEFAULT_AVATARS['Male'], ...DEFAULT_AVATARS['Female'], ...DEFAULT_AVATARS['Other']];
            
            let _r14 = 0;
            if (_p14) {
                _r14 = _l14.activeAvatarIndex;
            } else if (_l14.defaultAvatar) {
                const _s14 = _q14.indexOf(_l14.defaultAvatar);
                if (_s14 !== -1) {
                    _r14 = _s14;
                }
            }
            
            return {
              ..._l14,
              name: _l14.name || (_l14.gender === 'Female' ? 'Tax Dost' : _l14.gender === 'Male' ? 'Tax Dost' : ''),
              avatars: _q14,
              activeAvatarIndex: _r14,
              blockCount: _l14.blockCount || 0,
              isBlocked: _l14.isBlocked || false
            };
          };
          
          const [_t14, _u14] = useState(_o14());
           
          const _v14 = (_w14) => {
            if (_w14.target.files) {
              const _x14 = Array.from(_w14.target.files);
              _x14.forEach(_y14 => {
                const _z14 = new FileReader();
                _z14.onload = (_a15) => {
                  if (_a15.target && typeof _a15.target.result === 'string') {
                    _u14(_b15 => ({ ..._b15, avatars: [..._b15.avatars, _a15.target.result] }));
                  }
                };
                _z14.readAsDataURL(_y14);
              });
            }
          };

          const _c15 = (_d15) => {
            _u14(_e15 => {
              const _f15 = _e15.expertise || [];
              if (_f15.includes(_d15)) {
                return { ..._e15, expertise: _f15.filter(_g15 => _g15 !== _d15) };
              } else {
                return { ..._e15, expertise: [..._f15, _d15] };
              }
            });
          };

         const _h15 = (_i15) => {
            const _j15 = _i15 === 'Female' ? 'Tax Dost' : _i15 === 'Male' ? 'Tax Dost' : _t14.name;
            _u14(_k15 => ({ 
                ..._k15, 
                gender: _i15,
                name: _k15.name || _j15,
                activeAvatarIndex: 0
            }));
          };
          const _l15 = (_m15) => {
            _m15.preventDefault();
            if (_t14.name.trim() === '') {
                alert("Please enter a name for the character.");
                return;
            }
            if (_t14.expertise.length === 0 && !_t14.customPersonality) {
                alert("Please select at least one expertise area or add custom expertise & behaviour.");
                return;
            }
            _m14(_t14);
          };

          return (
            <form onSubmit={_l15} className="p-4 space-y-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-center text-gray-700">AI Character Profile</h2>
                <button type="button" onClick={_n14} className="text-gray-500 hover:text-gray-700">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
              </div>

              <div className="flex flex-col items-center space-y-3">
                <img
                  src={_t14.avatars?.[_t14.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${_t14.id}`}
                  alt="Character avatar"
                  className="w-24 h-24 rounded-full object-cover border-4 border-blue-200"
                />
                <div>
                    <label className="cursor-pointer text-sm text-blue-600 hover:underline">
                        Choose file
                        <input type="file" multiple accept="image/*" onChange={_v14} className="hidden" />
                    </label>
                    <p className="text-xs text-gray-500 mt-1">No file chosen</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Additional Images (Max 5)</label>
                <input
                    type="file"
                    multiple
                    accept="image/*"
                    onChange={_v14}
                    className="hidden"
                    id="additional-images"
                />
                <label 
                    htmlFor="additional-images"
                    className="cursor-pointer text-sm text-blue-600 hover:underline"
                >
                    Choose file
                </label>
                <p className="text-xs text-gray-500 mt-1">No file chosen</p>
                
                {_t14.avatars?.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                        {_t14.avatars.map((_n15, _o15) => (
                            <img
                                key={_o15}
                                src={_n15}
                                alt={`Avatar ${_o15 + 1}`}
                                className={`w-12 h-12 rounded-lg object-cover cursor-pointer border-2 ${
                                    _t14.activeAvatarIndex === _o15 ? 'border-blue-600' : 'border-gray-200'
                                }`}
                                onClick={() => _u14(_p15 => ({ ..._p15, activeAvatarIndex: _o15 }))}
                            />
                        ))}
                    </div>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Name *</label>
                <input
                  type="text"
                  value={_t14.name}
                  onChange={_q15 => _u14({ ..._t14, name: _q15.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="An" required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Age</label>
                <input
                  type="number"
                  value={_t14.age}
                  onChange={_r15 => _u14({ ..._t14, age: parseInt(_r15.target.value) || 18 })}
                  min="13"
                  max="100"
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="25" required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Gender</label>
                <select
                  value={_t14.gender}
                  onChange={_s15 => _h15(_s15.target.value)}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  {Object.values(Gender).map(_t15 => <option key={_t15} value={_t15}>{_t15}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Act Like</label>
                <select
                  value={_t14.actLike}
                  onChange={_u15 => _u14({ ..._t14, actLike: _u15.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  {Object.values(ActLike).map(_v15 => <option key={_v15} value={_v15}>{_v15}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Expert</label>
                <div className="flex flex-wrap gap-2">
                  {Object.values(Expert).map(_w15 => (
                    <button
                      key={_w15}
                      type="button"
                      onClick={() => _c15(_w15)}
                      className={`px-3 py-2 rounded-full text-sm font-medium transition-colors ${
                        _t14.expertise?.includes(_w15)
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      {_w15.replace(/_/g, ' ')}
                    </button>
                  ))}
                </div>
                <p className="text-xs text-gray-500 mt-2">Select expertise areas for your CA. Multiple selections allowed.</p>
              </div>

               <div>
                <label className="block text-sm font-medium text-gray-700">Custom Expertise & Behaviour (Optional)</label>
                 <textarea
                  value={_t14.customPersonality || ''}
                  onChange={_x15 => _u14({ ..._t14, customPersonality: _x15.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  rows={3}
                  placeholder="Describe specific expertise not listed above or preferred behavior style (e.g., 'Short answers in bullet points', 'Detailed explanations with examples', 'Focus on practical applications')"
                />
              </div>

              <div className="flex justify-end space-x-2 pt-4">
                <button 
                    type="button" 
                    onClick={_n14} 
                    className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                >
                    Save Profile
                </button>
              </div>
            </form>
          );
        };

        const GroupSetup = ({ characters: _y15, onSave: _z15, onCancel: _a16 }) => {
          const [_b16, _c16] = useState({ 
              id: `group_${Date.now()}`, 
              name: '', 
              members: [], 
              messages: [],
              blockCount: 0,
              isBlocked: false
          });

          const _d16 = (_e16) => {
            _c16(_f16 => {
              const _g16 = _f16.members.includes(_e16) 
                ? _f16.members.filter(_h16 => _h16 !== _e16)
                : [..._f16.members, _e16];
              return { ..._f16, members: _g16 };
            });
          };

          const _i16 = (_j16) => {
            _j16.preventDefault();
            if (_b16.name.trim() === '') {
              alert("Please enter a name for the group.");
              return;
            }
            if (_b16.members.length === 0) {
              alert("Please select at least one AI profile for the group.");
              return;
            }
            _z15(_b16);
          };

          return (
            <form onSubmit={_i16} className="p-4 space-y-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-center text-gray-700">Create Group Chat</h2>
                <button type="button" onClick={_a16} className="text-gray-500 hover:text-gray-700">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Group Name</label>
                <input
                  type="text"
                  value={_b16.name}
                  onChange={_k16 => _c16({ ..._b16, name: _k16.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="E.g., Friends Group" required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Select AI Profiles</label>
                <div className="mt-1 space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                  {_y15.map(_l16 => (
                    <label key={_l16.id} className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={_b16.members.includes(_l16.id)}
                        onChange={() => _d16(_l16.id)}
                        className="rounded text-blue-600 focus:ring-blue-500"
                      />
                      <span className="text-sm text-gray-700">{_l16.name} ({_l16.relationship})</span>
                    </label>
                  ))}
                </div>
              </div>
              <div className="flex justify-end space-x-2 pt-4">
                <button 
                    type="button" 
                    onClick={_a16} 
                    className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                >
                    Create Group
                </button>
              </div>
            </form>
          );
        };

        const GroupEdit = ({ group: _m16, characters: _n16, onSave: _o16, onCancel: _p16 }) => {
            const [_q16, _r16] = useState({ 
                ..._m16,
                blockCount: _m16.blockCount || 0,
                isBlocked: _m16.isBlocked || false
            });

            const _s16 = (_t16) => {
                _r16(_u16 => {
                    const _v16 = _u16.members.includes(_t16) 
                        ? _u16.members.filter(_w16 => _w16 !== _t16)
                        : [..._u16.members, _t16];
                    return { ..._u16, members: _v16 };
                });
            };

            const _x16 = (_y16) => {
                _y16.preventDefault();
                if (_q16.name.trim() === '') {
                    alert("Please enter a name for the group.");
                    return;
                }
                if (_q16.members.length === 0) {
                    alert("Please select at least one AI profile for the group.");
                    return;
                }
                _o16(_q16);
            };

            return (
                <form onSubmit={_x16} className="p-4 space-y-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-center text-gray-700">Edit Group Chat</h2>
                        <button type="button" onClick={_p16} className="text-gray-500 hover:text-gray-700">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Group Name</label>
                        <input
                            type="text"
                            value={_q16.name}
                            onChange={_z16 => _r16({ ..._q16, name: _z16.target.value })}
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="E.g., Friends Group" required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Members</label>
                        <div className="mt-1 space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                            {_n16.map(_a17 => (
                                <label key=_a17.id className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={_q16.members.includes(_a17.id)}
                                        onChange={() => _s16(_a17.id)}
                                        className="rounded text-blue-600 focus:ring-blue-500"
                                    />
                                    <span className="text-sm text-gray-700">{_a17.name} ({_a17.relationship})</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-2 pt-4">
                        <button 
                            type="button" 
                            onClick={_p16} 
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            Save
                        </button>
                    </div>
                </form>
            );
        };

        const Sidebar = ({ isOpen: _b17, onClose: _c17, characters: _d17, groups: _e17, onSelectCharacter: _f17, onSelectGroup: _g17, showIndividual: _h17, setShowIndividual: _i17 }) => {
            if (!_b17) return null;

            return (
                <>
                    <div className="fixed inset-0 bg-black bg-opacity-50 z-40" onClick={_c17}></div>
                    <div className="fixed left-0 top-0 h-full w-80 bg-white z-50 shadow-lg transform transition-transform">
                        <div className="p-4 border-b">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-bold">Chat History</h2>
                                <button onClick={_c17} className="text-gray-500 hover:text-gray-700">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                <button
                                    onClick={() => _i17(true)}
                                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                                        _h17 ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                    }`}
                                >
                                    Individual
                                </button>
                                <button
                                    onClick={() => _i17(false)}
                                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                                        !_h17 ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                    }`}
                                >
                                    Group
                                </button>
                            </div>
                        </div>
                        <div className="p-4 overflow-y-auto h-full">
                            {_h17 ? (
                                <div className="space-y-2">
                                    {_d17.map(_j17 => (
                                        <div
                                            key={_j17.id}
                                            onClick={() => {
                                                _f17(_j17.id);
                                                _c17();
                                            }}
                                            className="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                        >
                                            <img
                                                src={_j17.avatars?.[_j17.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${_j17.id}`}
                                                alt={_j17.name}
                                                className="w-10 h-10 rounded-full object-cover"
                                            />
                                            <div className="ml-3">
                                                <p className="font-semibold text-gray-800">{_j17.name}</p>
                                                <p className="text-sm text-gray-600">{_j17.relationship}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {_e17.map(_k17 => (
                                        <div
                                            key={_k17.id}
                                            onClick={() => {
                                                _g17(_k17.id);
                                                _c17();
                                            }}
                                            className="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                        >
                                            <div className="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center">
                                                <span className="text-blue-800 font-semibold">{_k17.name[0]}</span>
                                            </div>
                                            <div className="ml-3">
                                                <p className="font-semibold text-gray-800">{_k17.name}</p>
                                                <p className="text-sm text-gray-600">Group ({_k17.members.length} members)</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                         </div>
                    </div>
                </>
            );
        };

        const ChatScreen = ({ character: _l17, userProfile: _m17, onCharacterUpdate: _n17, onBack: _o17, onUserProfileUpdate: _p17, backgroundUrl: _q17, onSetBackground: _r17 }) => {

            const TOTAL_API_KEYS = 3;
          const [_s17, _t17] = useState(_l17.messages);
          const [_u17, _v17] = useState(false);
          const [_w17, _x17] = useState(false);
          const [_y17, _z17] = useState(false);
          const [_a18, _b18] = useState(_l17.blockCount || 0);
          const [_c18, _d18] = useState(_l17.isBlocked || false);
          
          const _e18 = useRef(_s17);
          _e18.current = _s17;

          useEffect(() => {
            _n17({ ..._l17, messages: _s17, blockCount: _a18, isBlocked: _c18 });
          }, [_s17, _a18, _c18]);

       const _f18 = useCallback(async (_g18, _h18 = []) => {
    if (_c18) return;

    const _i18 = {
        id: `msg_${Date.now()}`,
        sender: MessageSender.USER,
        text: _g18,
        attachments: _h18,
        timestamp: Date.now(),
    };
    let _j18 = _g18;

    if (_h18 && _h18.length > 0) {
      const _k18 = _h18.map(_l18 => {
       
if (_l18.type.startsWith('text/') || _l18.type.includes('json') || _l18.type.includes('csv') || _l18.type.includes('pdf') || _l18.type.includes('wordprocessingml.document') || _l18.type.startsWith('image/')) {
    return `\n\n--- Attached File: ${_l18.name} ---\n${_l18.content}\n--- End of File ---`;
        }
        return '';
      }).join('');
      
      _j18 += _k18;
    }

    const _m18 = { ..._i18, text: _j18 };



      const _n18 = [..._e18.current, _i18];
    _t17(_n18);
    _v17(true);

    const _o18 = `msg_${Date.now() + 1}`;
    _t17(_p18 => [..._p18, { id: _o18, sender: MessageSender.AI, text: '', timestamp: Date.now() }]);

    const _q18 = (_r18) => {
            _t17(_s18 =>
                _s18.map(_t18 =>
                    _t18.id === _o18 ? { ..._t18, text: _t18.text + (_t18.text.endsWith('\n\nSomething went wrong. Please retry.') ? '' : _r18) } : _t18
                )
            );
        };

        let _u18 = false;
        let _v18 = 0;

        while (!_u18 && _v18 < TOTAL_API_KEYS) {
            const _w18 = await apiKeyManager.getDeactivatedKeys();
            if (_w18.some(_x18 => _x18.index === _v18)) {
                console.log(`Key index ${_v18} is on cooldown. Skipping.`);
                _v18++;
                continue;
            }

            try {
                const _y18 = await generateChatResponseStream(_l17, _m17, _n18, _m18, _q18, () => {}, _v18);

                if (_y18.status === 429) {
                    
                    const _z18 = await _y18.json();
                    throw { name: 'QuotaError', failedIndex: _z18.failedKeyIndex };
                }

                if (!_y18.ok) {
                    throw new Error(`Server error: ${_y18.statusText}`);
                }
                
                _u18 = true;
                currentKeyIndex = _v18;
                const _a19 = _y18.body.getReader();
                const _b19 = new TextDecoder();
                let _c19 = '';

                while (true) {
                    const { done: _d19, value: _e19 } = await _a19.read();
                    if (_d19) break;
                    const _f19 = _b19.decode(_e19, { stream: true });
                    _c19 += _f19;
                    _q18(_f19);
                }

                if (_c19.trim() === '[BLOCK_USER]') {
                    _b18(_g19 => _g19 + 1);
                    _d18(true);
                    _t17(_h19 => _h19.filter(_i19 => _i19.id !== _o18));
                }

            } catch (_j19) {
                if (_j19.name === 'QuotaError') {
                    console.warn(`Key at index ${_j19.failedIndex} failed. Deactivating and trying next.`);
                    await apiKeyManager.deactivateKey(_j19.failedIndex);
                    _v18++;
                } else {
                    console.error("A non-quota error occurred:", _j19);
                    _q18("\n\nSomething went wrong. Please retry.");
                    break; 
                }
            }
        }

        if (!_u18) {
            console.error("All API keys failed or were on cooldown.");
            _t17(_k19 => _k19.map(_l19 => 
                _l19.id === _o18 && _l19.text === '' 
                ? {..._l19, text: "All services are currently busy. Please try again later."} 
                : _l19
            ));
        }
        
        _v17(false);
    }, [_l17, _m17, _c18]);

    const [_m19, _n19] = useState([]);

    const _o19 = (_p19, _q19) => {
        const _r19 = _s17.map(_t19 =>
            _t19.id === _p19 ? { ..._t19, text: _q19 } : _t19
        );
        _t17(_r19);
    };

    const _u19 = (_v19) => {
        const _w19 = _s17.filter(_x19 => _x19.id !== _v19);
        _t17(_w19);
        _n19(_y19 => _y19.filter(_z19 => _z19 !== _v19));
    };

    const _a20 = (_b20) => {
        _n19(_c20 => 
            _c20.includes(_b20) 
                ? _c20.filter(_d20 => _d20 !== _b20)
                : [..._c20, _b20]
        );
    };

    const _e20 = (_f20) => {
        _n19(_g20 => 
            _g20.includes(_f20) ? _g20 : [..._g20, _f20]
        );
    };

    const _h20 = () => {
        if (_m19.length > 0 && confirm(`Delete ${_m19.length} selected message(s)?`)) {
            const _i20 = _s17.filter(_j20 => !_m19.includes(_j20.id));
            _t17(_i20);
            _n19([]);
        }
    };

          const _k20 = () => {
            if (_a18 >= 3) {
                alert("You have been blocked permanently. This chat will be deleted.");
                setCharacters(_l20 => _l20.filter(_m20 => _m20.id !== _l17.id));
                setGroups(_n20 => _n20.map(_o20 => ({
                    ..._o20,
                    members: _o20.members.filter(_p20 => _p20 !== _l17.id)
                })).filter(_q20 => _q20.members.length > 0));
                _o17();
                return;
            }
            _d18(false);
          };
          
          const _r20 = () => {
              if (window.confirm("Are you sure you want to delete all messages in this chat?")) {
                _t17([]);
                _b18(0);
                _d18(false);
              }
          }
          
          const _s20 = (_t20) => {
            _n17({..._t20, messages: _s17, blockCount: _a18, isBlocked: _c18});
            _x17(false);
          }
          
          const _u20 = (_v20) => {
            _p17(_v20);
            _z17(false);
          }

          return (
             <div className="app-container w-full bg-gray-100">
              <ChatHeader 
                character={_l17} 
                onBack={_o17} 
                onEditAiProfile={() => _x17(true)}
                onEditUserProfile={() => _z17(true)}
                onClearChat={_r20}
                onSetBackground={_r17}
              />
                            

              {_m19.length > 0 && (
                <div className="fixed top-20 left-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-20 flex justify-between items-center">
                  <span className="text-sm font-medium">{_m19.length} message(s) selected</span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => _n19([])}
                      className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={_h20}
                      className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              )}
              <MessageList 
                messages={_s17} 
                character={_l17} 
                userProfile={_m17} 
                isTyping={_u17} 
                backgroundUrl={_q17}
                onEditMessage={_o19}
                onDeleteMessage={_u19}
                selectedMessages={_m19}
                onSelectMessage={_a20}
                onLongPressMessage={_e20}
                isBlocked={_c18}
                blockCount={_a18}
                characterName={_l17.name}
                handleUnblock={_k20}
              />
              <MessageInput onSend={_f18} isBlocked={_c18} />

              {_w17 && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <CharacterSetup
                            initialCharacter={{ ..._l17, blockCount: _a18, isBlocked: _c18 }}
                            onSave={_s20}
                            onCancel={() => _x17(false)}
                        />
                    </div>
                </div>
              )}

              {_y17 && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <UserProfileSetup
                            userProfile={_m17}
                            onSave={_u20}
                            onCancel={() => _z17(false)}
                        />
                    </div>
                </div>
              )}
            </div>
          );
        };

  const GroupChatScreen = ({ group: _w20, characters: _x20, userProfile: _y20, onGroupUpdate: _z20, onBack: _a21, onUserProfileUpdate: _b21, backgroundUrl: _c21, onSetBackground: _d21 }) => {
    const TOTAL_API_KEYS = 3;

    const [_e21, _f21] = useState(_w20.messages || []);
    const [_g21, _h21] = useState(false);
    const [_i21, _j21] = useState(false);
    const [_k21, _l21] = useState(false);
    const [_m21, _n21] = useState(0);
    const [_o21, _p21] = useState(_w20.blockCount || 0);
    const [_q21, _r21] = useState(_w20.isBlocked || false);
    const _s21 = useRef(_e21);
    useEffect(() => { _s21.current = _e21; }, [_e21]);

      useEffect(() => {
        _z20({ ..._w20, messages: _e21, blockCount: _o21, isBlocked: _q21 });
    }, [_e21, _o21, _q21]);

    const _t21 = useMemo(() => 
        _w20.members.map(_u21 => _x20.find(_v21 => _v21.id === _u21)).filter(Boolean), 
        [_w20.members, _x20]
    );

    

    const _w21 = useCallback(async (_x21, _y21 = '', _z21 = []) => {
        if (_q21) return;
        
        const _a22 =  false;
        
         let _b22 = _y21;

    if (!_x21 && _z21 && _z21.length > 0) {
        const _c22 = _z21.map(_d22 => {
        
if (_d22.type.startsWith('text/') || _d22.type.includes('json') || _d22.type.includes('csv') || _d22.type.includes('pdf') || _d22.type.includes('wordprocessingml.document') || _d22.type.startsWith('image/')) {
                return `\n\n--- Attached File: ${_d22.name} ---\n${_d22.content}\n--- End of File ---`;
            }
            return '';
        }).join('');
        
        _b22 += _c22;
    }
    
        let _e22;
    if (_x21) {
        let _f22 = _a22 ?
            '[System: User is listening, continue naturally.]' :
            `[System: User skipped. ${_m21 + 1 >= 2 ? 'User seems unavailable, continue among AIs.' : 'Continue conversation.'}]`;
        _e22 = {
            text: _f22
        };
    } else {
        _e22 = {
            id: `msg_${Date.now()}`,
            sender: MessageSender.USER,
            text: _y21,
            attachments: _z21,
            timestamp: Date.now()
        };
    }
         // AI ke liye ek alag message object banayein jisme file content bhi hai.
    const _g22 = { ..._e22, text: _b22 };

        let _h22 = [..._s21.current];
        if (!_x21) {
            _h22.push(_e22);
            _f21(_h22);
        }

        _h21(true);
        const _i22 = _x21 ? _m21 + 1 : 0;
        _n21(_i22);

        const _j22 = `stream_${Date.now()}`;
        _f21(_k22 => [..._k22, {
        id: _j22,
        sender: 'group',
        text: '',
        timestamp: Date.now()
    }]);

    const _l22 = (_m22) => {
        _f21(_n22 => _n22.map(_o22 => _o22.id === _j22 ? { ..._o22,
            text: _o22.text + _m22
        } : _o22));
    };
        
        let _p22 = false;
        let _q22 = 0;

        while (!_p22 && _q22 < TOTAL_API_KEYS) {
            const _r22 = await apiKeyManager.getDeactivatedKeys();
            if (_r22.some(_s22 => _s22.index === _q22)) {
                console.log(`Key index ${_q22} is on cooldown for group chat. Skipping.`);
                _q22++;
                continue;
            }

            try { 
                const _t22 = await generateGroupChatResponseStream(_t21, _y20, _h22, _g22, _l22, _i22, () => {}, _q22);


                if (_t22.status === 429) {
                    const _u22 = await _t22.json();
                    throw { name: 'QuotaError', failedIndex: _u22.failedKeyIndex };
                }
                if (!_t22.ok) {
                    throw new Error(`Server error: ${_t22.statusText}`);
                }

                _p22 = true;
                currentKeyIndex = _q22;
                const _v22 = _t22.body.getReader();
                const _w22 = new TextDecoder();
                let _x22 = '';

                while (true) {
                    const { done: _y22, value: _z22 } = await _v22.read();
                    if (_y22) break;
                    const _a23 = _w22.decode(_z22, { stream: true });
                    _x22 += _a23;
                }
                
               

                if (_x22.includes('[BLOCK_USER]')) {
                    _p21(_b23 => _b23 + 1);
                    _r21(true);
                    _f21(_c23 => _c23.filter(_d23 => _d23.id !== _j22));
                } else {
                    const _e23 = [];
                    const _f23 = _x22.split('\n');
                    
                    const _g23 = /^([\w\s]+):\s*(.*)/;

                    _f23.forEach(_h23 => {
                        const _i23 = _h23.match(_g23);

                        if (_i23) {
                            const _j23 = _i23[1].trim();
                            const _k23 = _i23[2].trim();
                            const _l23 = _t21.find(_m23 => _m23.name === _j23);

                            if (_l23) {
                                _e23.push({
                                    id: `msg_${Date.now()}_${Math.random()}`,
                                    sender: _l23.id,
                                    text: _k23,
                                    timestamp: Date.now()
                                });
                            }
                        } else if (_e23.length > 0 && _h23.trim().length > 0) {
                            _e23[_e23.length - 1].text += '\n' + _h23;
                        }
                    });
        
                    _f21(_n23 => [..._n23.filter(_o23 => _o23.id !== _j22), ..._e23.filter(_p23 => _p23.text)]);
                }

            } catch (_q23) {
                if (_q23.name === 'QuotaError') {
                    console.warn(`Key at index ${_q23.failedIndex} failed for group chat. Deactivating.`);
                    await apiKeyManager.deactivateKey(_q23.failedIndex);
                    _q22++;
                } else {
                    console.error("Group chat API error:", _q23);
                    _f21(_r23 => _r23.map(_s23 => _s23.id === _j22 ? {..._s23, text: "Something went wrong."} : _s23));
                    break;
                }
            }
        }
        
        if (!_p22) {
            console.error("All API keys for group chat failed.");
            _f21(_t23 => _t23.map(_u23 => _u23.id === _j22 ? {..._u23, text: "All services are currently busy. Please try again later."} : _u23));
        }

        _h21(false);
    }, [_t21, _y20, _m21, _q21]);
    
    const _v23 = (_w23, _x23 = []) => _w21(false, _w23, _x23);
    const _y23 = () => _w21(true);

    const _z23 = () => {
        if (_o21 >= 3) {
            alert("You have been blocked permanently. This group chat will be deleted.");
            _a21();
            return;
        }
        _r21(false);
    };

    const _a24 = () => {
        if (window.confirm("Are you sure you want to delete all messages in this group chat?")) {
            _f21([]);
            _p21(0);
            _r21(false);
        }
    };

    const _b24 = (_c24) => {
        _b21(_c24);
        _j21(false);
    };

    const _d24 = (_e24) => {
        _z20({ ..._e24, messages: _e21, blockCount: _o21, isBlocked: _q21 });
        _l21(false);
    };

    const [_f24, _g24] = useState([]);

    const _h24 = (_i24, _j24) => {
        const _k24 = _e21.map(_l24 =>
            _l24.id === _i24 ? { ..._l24, text: _j24 } : _l24
        );
        _f21(_k24);
    };

    const _m24 = (_n24) => {
        const _o24 = _e21.filter(_p24 => _p24.id !== _n24);
        _f21(_o24);
        _g24(_q24 => _q24.filter(_r24 => _r24 !== _n24));
    };

    const _s24 = (_t24) => {
        _g24(_u24 => 
            _u24.includes(_t24) 
                ? _u24.filter(_v24 => _v24 !== _t24)
                : [..._u24, _t24]
        );
    };

    const _w24 = (_x24) => {
        _g24(_y24 => 
            _y24.includes(_x24) ? _y24 : [..._y24, _x24]
        );
    };

    const _z24 = () => {
        if (_f24.length > 0 && confirm(`Delete ${_f24.length} selected message(s)?`)) {
            const _a25 = _e21.filter(_b25 => !_f24.includes(_b25.id));
            _f21(_a25);
            _g24([]);
        }
    };

    return (
        <div className="app-container w-full bg-gray-100">
            <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                <button onClick={_a21} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div className="ml-3 flex-grow">
                    <h2 className="font-semibold text-lg">{_w20.name}</h2>
                    <p className="text-sm opacity-90">Group Chat • {_t21.length} members</p>
                </div>
                <div className="flex items-center gap-1">
                    <button onClick={() => _l21(true)} className="p-2 text-white hover:bg-white/20 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    </button>
                    <button onClick={_a24} className="p-2 text-white hover:bg-white/20 rounded">
                         <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                    <button onClick={() => _j21(true)} className="p-2 text-white hover:bg-white/20 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </button>
                </div>
            </header>
                        

            {_f24.length > 0 && (
                <div className="fixed top-20 left-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-20 flex justify-between items-center">
                  <span className="text-sm font-medium">{_f24.length} message(s) selected</span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => _g24([])}
                      className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={_z24}
                      className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              )}
            <MessageList 
                messages={_e21} 
                characters={_x20}
                userProfile={_y20} 
                isTyping={_g21} 
                backgroundUrl={_c21}
                onEditMessage={_h24}
                onDeleteMessage={_m24}
                selectedMessages={_f24}
                onSelectMessage={_s24}
                onLongPressMessage={_w24}
                isBlocked={_q21}
                blockCount={_o21}
                groupName={_w20.name}
                handleUnblock={_z23}
            />
            <MessageInput onSend={_v23} onSkip={_y23} isBlocked={_q21} />
            {_i21 && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <UserProfileSetup
                            userProfile={_y20}
                            onSave={_b24}
                            onCancel={() => _j21(false)}
                        />
                    </div>
                </div>
            )}
            {_k21 && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <GroupEdit
                            group={_w20}
                            characters={_x20}
                            onSave={_d24}
                            onCancel={() => _l21(false)}
                        />
                    </div>
                </div>
            )}
        </div>
    );
};


        
        const InstructionsModal = ({ isOpen: _c25, onClose: _d25 }) => {
            if (!_c25) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl overflow-hidden">
                        <header className="flex items-center justify-between p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">App Guide & Instructions</h2>
                            <button 
                                onClick={_d25} 
                                className="p-2 text-gray-500 hover:text-gray-800 rounded-full hover:bg-gray-100"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </header>
                        <div className="flex-grow overflow-y-auto">
                            <iframe 
                                src="./instructions.html" 
                                className="w-full h-full border-0"
                                title="Instructions"
                            ></iframe>
                        </div>
                    </div>
                </div>
            );
        };
        const CharacterList = ({ characters: _e25, groups: _f25, onSelectCharacter: _g25, onSelectGroup: _h25, setCharacters: _i25, setGroups: _j25, setUserProfile: _k25, setChatBackground: _l25, userProfile: _m25, chatBackground: _n25, isGoogleAuthed: _o25, onLogout: _p25, onNavigateToUpdates: _q25 }) => {
          const [_r25, _s25] = useState(false);
          const [_t25, _u25] = useState(false);
          const [_v25, _w25] = useState(false);
          const [_x25, _y25] = useState(false);
          const [_z25, _a26] = useState(true);
        const [_b26, _c26] = useState(false); 
          const _d26 = useRef(null);

          const _e26 = (_f26) => {
            _i25(_g26 => [..._g26, _f26]);
            _s25(false);
          };

          const _h26 = (_i26) => {
            _j25(_j26 => [..._j26, _i26]);
            _u25(false);
            _h25(_i26.id);
          };

         const _k26 = (_l26, _m26) => {
    _l26.stopPropagation();
    if (window.confirm("Are you sure you want to delete this AI profile? This will also remove it from all group chats.")) {
        _i25(_n26 => _n26.filter(_o26 => _o26.id !== _m26));
        _j25(_p26 => _p26.map(_q26 => ({
            ..._q26,
            members: _q26.members.filter(_r26 => _r26 !== _m26)
        })).filter(_s26 => _s26.members.length > 0));
    }
};

const _t26 = (_u26) => {
    _k25(_u26);
    _w25(false);
};

const _v26 = (_w26) => {
    const _x26 = _w26.target.files[0];
    if (_x26) {
        const _y26 = new FileReader();
        _y26.onload = (_z26) => {
            try {
                const _a27 = JSON.parse(_z26.target.result);

                if (_a27.userProfile) {
                    _k25(_a27.userProfile);
                }

                if (_a27.characters) {
                    _i25(_b27 => [..._b27, ..._a27.characters]);
                }
                if (_a27.groups) {
                    _j25(_c27 => [..._c27, ..._a27.groups]);
                }
                alert("Data imported successfully!");
            } catch (_d27) {
                console.error("Import error:", _d27);
                alert("Failed to import data. Please check the file format.");
            }
        };
        _y26.readAsText(_x26);
    }
};


const _e27 = () => {
    const _f27 = { userProfile: _m25, characters: _e25, groups: _f25 };
    const _g27 = new Blob([JSON.stringify(_f27, null, 2)], { type: 'application/json' });
    const _h27 = URL.createObjectURL(_g27);
    const _i27 = document.createElement('a');
    _i27.href = _h27;
    _i27.download = 'TaxFriend_data.json';
    _i27.click();
    URL.revokeObjectURL(_h27);
};

return (
    <>
        <div className="flex flex-col h-full bg-blue-600">
                      <header className="bg-blue-600 text-white p-4 pt-8 flex items-center justify-between">
                <div className="flex items-center gap-1">
                    <button onClick={() => _y25(true)} className="p-2 hover:bg-white/20 rounded">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <button onClick={_p25} className="p-2 hover:bg-white/20 rounded-full" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>

                <h1 className="text-xl font-bold">
                    Virtual Chartered Accountants
                </h1>

                <div className="flex items-center gap-2">
                    <button 
                        onClick={handleAuthClick} 
                        className={`py-1 px-3 rounded-full text-xs font-semibold transition-colors ${ _o25 ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-white hover:bg-gray-200 text-blue-600' }`}
                    >
                        {_o25 ? 'Drive Connected' : 'Connect to Drive'}
                    </button>
                            <button 
                                onClick={() => _c26(true)} 
                                className="p-2 rounded-full hover:bg-white/20"
                                title="Instructions"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                    <button onClick={() => _w25(true)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <img src={_m25.avatar || `https://i.pravatar.cc/150?u=${_m25.id}`} alt="Profile" className="w-8 h-8 rounded-full object-cover" />
                    </button>
                </div>
            </header>
            
            <main className="flex-grow bg-white rounded-t-3xl p-4 overflow-y-auto">
    <div className="flex justify-between items-center mb-6">
        <h3 className="text-lg font-bold text-gray-700">Chats</h3>
        <div className="flex gap-2">
            <button
                onClick={() => _s25(true)}
                className="py-2 px-3 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700"
            >
                New AI
            </button>
            <button
                onClick={() => _u25(true)}
                className="py-2 px-3 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700"
            >
                New Group
            </button>
            <button
                                onClick={_q25}
                                className="py-2 px-3 bg-teal-600 text-white rounded-full text-sm hover:bg-teal-700"
                            >
                                Latest Updates
             </button>
            <button
                onClick={() => _d26.current?.click()}
                className="py-2 px-3 bg-gray-600 text-white rounded-full text-sm hover:bg-gray-700"
            >
                Import
            </button>
            <input
                type="file"
                ref={_d26}
                accept=".json"
                onChange={_v26}
                className="hidden"
            />
            <button
                onClick={_e27}
                className="py-2 px-3 bg-gray-600 text-white rounded-full text-sm hover:bg-gray-700"
            >
                Export
            </button>
        </div>
    </div>
    {_e25.length === 0 && _f25.length === 0 ? (
        <div className="flex flex-col items-center justify-center h-full">
            <div className="bg-blue-100 rounded-full p-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
            </div>
            <h2 className="text-xl text-gray-700">Hey! I'm Tax Dost</h2>
            <p className="text-sm text-gray-500 text-center">Your personal Chartered Accountant. Ask me anything about tax, finance, or investments to get started! 💼</p>
            <button onClick={() => _s25(true)} className="mt-4 py-2 px-4 bg-blue-600 text-white rounded-full">+ New Chat</button>
        </div>
    ) : (
        <div className="space-y-3">
            {_e25.map(_j27 => (
                <div
                    key={_j27.id}
                    onClick={() => _g25(_j27.id)}
                    className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                >
                    <img
                        src={_j27.avatars?.[_j27.activeAvatarIndex] || `https://i.pravatar.cc/150?u=${_j27.id}`}
                        alt={_j27.name}
                        className="w-12 h-12 rounded-full object-cover"
                    />
                    <div className="ml-4 flex-grow">
                        <div className="flex items-center justify-between">
                            <p className="font-semibold text-gray-800">{_j27.name}</p>
                            <span className="text-xs text-gray-500">
                                {_j27.messages?.length > 0 ? new Date(_j27.messages[_j27.messages.length - 1].timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : ''}
                            </span>
                        </div>
                        <div className="flex items-center justify-between mt-1">
                            <p className="text-sm text-gray-600">{_j27.actLike} • {_j27.expertise[0] || 'General CA'}</p>

                            <button
                                onClick={_k26.bind(null, _l27, _j27.id)}
                                className="p-1 text-red-400 hover:text-red-600"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            ))}
            {_f25.map(_m27 => (
                <div
                    key={_m27.id}
                    onClick={() => _h25(_m27.id)}
                    className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                >
                    <div className="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center">
                        <span className="text-blue-800 font-semibold">{_m27.name[0]}</span>
                    </div>
                    <div className="ml-4 flex-grow">
                        <div className="flex items-center justify-between">
                            <p className="font-semibold text-gray-800">{_m27.name}</p>
                            <span className="text-xs text-gray-500">
                                {_m27.messages?.length > 0 ? new Date(_m27.messages[_m27.messages.length - 1].timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : ''}
                            </span>
                        </div>
                        <div className="flex items-center justify-between mt-1">
                            <p className="text-sm text-gray-600">Group ({_m27.members.length} members)</p>
                            <button
                                onClick={_n27 => { _n27.stopPropagation(); if (window.confirm("Are you sure you want to delete this group?")) { _j25(_o27 => _o27.filter(_p27 => _p27.id !== _m27.id)); } }}
                                className="p-1 text-red-400 hover:text-red-600"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    )}
</main>
        </div>

        <Sidebar
            isOpen={_x25}
            onClose={() => _y25(false)}
            characters={_e25}
            groups={_f25}
            onSelectCharacter={_g25}
            onSelectGroup={_h25}
            showIndividual={_z25}
            setShowIndividual={_a26}
        />

        {_r25 && (
           <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <CharacterSetup
                        initialCharacter={{
                            id: `char_${Date.now()}`,
                            name: '',
                            actLike: ActLike.FRIEND,
                            gender: Gender.FEMALE,
                            age: 25,
                            expertise: [Expert.TAX_CONSULTANT],
                            avatars: [],
                            defaultAvatar: '01_CAGIRL.png',
                            activeAvatarIndex: 0,
                            messages: [],                         customPersonality: '',
                            blockCount: 0,
                            isBlocked: false
                        }}
                        onSave={_e26}
                        onCancel={() => _s25(false)}
                    />
                </div>
            </div>
        )}
        {_t25 && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <GroupSetup
                        characters={_e25}
                        onSave={_h26}
                        onCancel={() => _u25(false)}
                    />
                </div>
            </div>
        )}
        {_v25 && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <UserProfileSetup
                        userProfile={_m25}
                        onSave={_t26}
                        onCancel={() => _w25(false)}
                    />
                </div>
            </div>
        )}
        <InstructionsModal 
            isOpen={_b26} 
            onClose={() => _c26(false)} 
        />
    </>
);
};





const CardForm = ({ initialCard: _q27, onSave: _r27, onCancel: _s27 }) => {
    const [_t27, _u27] = useState(_q27 || {
        id: `card_${Date.now()}`,
        name: '',
        topic: '',
        description: '',
        emoji: '📄'
    });

    const EMOJI_OPTIONS = ['📄', '📅', '📈', '💡', '📰', '💼', '📊', '🔔'];

    const _v27 = (_w27) => {
        _w27.preventDefault();
        if (!_t27.name.trim() || !_t27.topic.trim()) {
            alert("Card Name and Topic/Keywords are required.");
            return;
        }
        _r27(_t27);
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-gray-500 via-gray-700 to-gray-900 flex items-center justify-center p-4">
            <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl p-8 w-full max-w-md">
                <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">
                    {_q27 ? "Edit Update Card" : "Create New Update Card"}
                </h1>
                
                <form onSubmit={_v27} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Card Name</label>
                        <input
                            type="text"
                            value={_t27.name}
                            onChange={_x27 => _u27({ ..._t27, name: _x27.target.value })}
                            placeholder="e.g., My GST Tracker"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Topic / Keywords (for Google Search)</label>
                        <input
                            type="text"
                            value={_t27.topic}
                            onChange={_y27 => _u27({ ..._t27, topic: _y27.target.value })}
                            placeholder="e.g., Latest GST notifications India"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Description (Optional)</label>
                         <textarea
                            value={_t27.description}
                            onChange={_z27 => _u27({ ..._t27, description: _z27.target.value })}
                            rows={3}
                            placeholder="What does this card track?"
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Select Icon</label>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {EMOJI_OPTIONS.map(_a28 => (
                                <button
                                    key={_a28}
                                    type="button"
                                    onClick={() => _u27({ ..._t27, emoji: _a28 })}
                                    className={`text-2xl p-2 rounded-lg ${
                                        _t27.emoji === _a28 ? 'bg-blue-500 ring-2 ring-blue-700' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {_a28}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-2 pt-4">
                        <button
                            type="button"
                            onClick={_s27}
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                            Save Card
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

const CardViewScreen = ({ card: _b28, onBack: _c28 }) => {
    const [_d28, _e28] = useState([]);
    const [_f28, _g28] = useState(false);
    const [_h28, _i28] = useState(null);
    
    const _j28 = async () => {
        _g28(true);
        _i28(null);
        _e28([]);
        try {

            const _k28 = currentKeyIndex;

            const _l28 = await fetch('/api/get-updates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic: _b28.topic, keyIndex: _k28 })
            });
            
            if (!_l28.ok) {
                if (_l28.status === 429) {
                    throw new Error("Quota exceeded for this API key. Please try again later.");
                }
                throw new Error(`Server error: ${_l28.statusText}`);
            }
            
            const _m28 = await _l28.json();
            if (_m28.updates) {
                _e28(_m28.updates);
            } else {
                _i28(_m28.error || "Failed to get updates.");
            }
            
        } catch (_n28) {
            _i28(_n28.message);
        } finally {
            _g28(false);
        }
    };
    
    useEffect(() => {
        _j28();
    }, [_b28]);
    
    return (
        <div className="app-container w-full bg-gray-100">
            <header className="fixed-header bg-blue-600 text-white p-3 flex items-center shadow-md">
                <button onClick={_c28} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div className="ml-3 flex-grow">
                    <h2 className="font-semibold text-lg">{_b28.emoji} {_b28.name}</h2>
                    <p className="text-sm opacity-90 truncate">{_b28.topic}</p>
                </div>
                <button
                    onClick={_j28}
                    disabled={_f28}
                    className="p-2 rounded-full hover:bg-white/20 disabled:opacity-50"
                    title="Refresh Updates"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${_f28 ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                    </svg>
                </button>
            </header>
            
            <main className="message-container p-4">
                {_b28.description && (
                    <div className="p-3 bg-white rounded-lg shadow mb-4">
                        <p className="text-sm text-gray-700 italic">{_b28.description}</p>
                    </div>
                )}
                
                {_f28 && (
                    <div className="flex justify-center items-center h-32">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                        <p className="ml-3 text-gray-600">Fetching latest updates...</p>
                    </div>
                )}
                
                {_h28 && (
                     <div className="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <p className="font-bold">Error:</p>
                        <p>{_h28}</p>
                    </div>
                )}
                
                {!_f28 && !_h28 && _d28.length === 0 && (
                    <div className="p-3 bg-blue-100 border border-blue-300 text-blue-800 rounded-lg text-center">
                        <p>No significant updates found for today.</p>
                    </div>
                )}
                
                {!_f28 && !_h28 && _d28.length > 0 && (
                    <div className="space-y-3">
                        {_d28.map((_o28, _p28) => (
                            <div key={_p28} className="p-4 bg-white rounded-xl shadow-md flex items-start gap-3">
                                <span className="text-blue-500 font-bold text-lg">{_p28 + 1}.</span>
                                <p className="text-gray-800">{_o28}</p>
                            </div>
                        ))}
                    </div>
                )}
            </main>
        </div>
    );
};

const UpdatesDashboardScreen = ({ cards: _q28, onNavigateBack: _r28, onNavigateToForm: _s28, onNavigateToView: _t28, onCardUpdate: _u28, onCardDelete: _v28 }) => {
    
    const _w28 = (_x28, _y28) => {
        _x28.stopPropagation();
        _s28(_y28);
    };
    
    const _z28 = (_a29, _b29) => {
        _a29.stopPropagation();
        if (window.confirm("Are you sure you want to delete this update card?")) {
            _v28(_b29);
        }
    };
    
    return (
        <div className="flex flex-col h-full bg-blue-600">
            <header className="bg-blue-600 text-white p-4 pt-8 flex items-center justify-between">
                <button onClick={_r28} className="p-2 hover:bg-white/20 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 className="text-xl font-bold">Latest Updates</h1>
                <div className="w-10"></div>
            </header>
            
            <main className="flex-grow bg-white rounded-t-3xl p-4 overflow-y-auto">
                {_q28.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full">
                        <div className="bg-blue-100 rounded-full p-4 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-4-4h2" />
                            </svg>
                        </div>
                        <h2 className="text-xl text-gray-700">Create your first Update Card</h2>
                        <p className="text-sm text-gray-500 text-center">Track daily news on topics that matter to you.</p>
                        <button onClick={() => _s28(null)} className="mt-4 py-2 px-4 bg-blue-600 text-white rounded-full">
                            + Create Card
                        </button>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {_q28.map(_c29 => (
                            <div
                                key={_c29.id}
                                onClick={() => _t28(_c29)}
                                className="flex items-center p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
                            >
                                <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                    <span className="text-3xl">{_c29.emoji}</span>
                                </div>
                                <div className="ml-4 flex-grow min-w-0">
                                    <p className="font-semibold text-gray-800 truncate">{_c29.name}</p>
                                    <p className="text-sm text-gray-600 truncate">{_c29.topic}</p>
                                </div>
                                <div className="flex-shrink-0 flex gap-1 ml-2">
                                    <button
                                        onClick={_w28.bind(null, _d29, _c29)}
                                        className="p-2 text-blue-500 hover:bg-blue-100 rounded-full"
                                        title="Edit Card"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                    <button
                                        onClick={_z28.bind(null, _e29, _c29.id)}
                                        className="p-2 text-red-500 hover:bg-red-100 rounded-full"
                                        title="Delete Card"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {_q28.length > 0 && (
                    <button
                        onClick={() => _s28(null)}
                        className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700"
                        title="Create New Card"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                )}
            </main>
        </div>
    );
};
        
const DrivePromptModal = ({ onConnect: _f29, onSkip: _g29 }) => {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Sync Your Data</h2>
                <p className="text-gray-600 mb-6">
                    Connect to Google Drive to securely back up and sync your chat history across devices.
                </p>
                <div className="flex flex-col gap-3">
                    <button
                        onClick={_f29}
                        className="w-full py-3 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors"
                    >
                        Continue with Google Drive
                    </button>
                    <button
                        onClick={_g29}
                        className="w-full py-2 px-4 rounded-lg font-semibold text-gray-500 hover:bg-gray-200 transition-colors"
                    >
                        Continue without Drive
                    </button>
                </div>
            </div>
        </div>
    );
};


const App = () => {
    const [_h29, _i29] = useState({ id: `user_${Date.now()}`, name: 'Alex', age: 25, gender: Gender.MALE, avatar: '01_CABOY.png' });
    const [_j29, _k29] = useState([]);
    const [_l29, _m29] = useState([]);
    const [_n29, _o29] = useState([]);
    
    const [_p29, _q29] = useState(false);
    const [_r29, _s29] = useState(0);
    const [_t29, _u29] = useState(null);
    const [_v29, _w29] = useState(false);
    
    const [_x29, _y29] = useState(null);
    const [_z29, _a30] = useState(true);
    
    const [_b30, _c30] = useState(false);
    
    const [_d30, _e30] = useState({ screen: 'chats' }); 

    const _f30 = useRef(null);
    const _g30 = useRef(null);

    useEffect(() => {
        const _h30 = async () => {
            try {
                console.log("Loading all data from IndexedDB...");
                _s29(10);
                const _i30 = await window.chatbotStorage.getUserProfile();
                if (_i30) _i29(_i30);
                _s29(25);
                
                const _j30 = await window.chatbotStorage.getCharacters();
                if (_j30) _k29(_j30);
                _s29(50);
                
                const _k30 = await window.chatbotStorage.getGroups();
                if (_k30) _m29(_k30);
                _s29(75);

                const _l30 = await window.chatbotStorage.getUpdateCards();
                if (_l30) _o29(_l30);
                _s29(100);

                setTimeout(() => _q29(true), 500);
            } catch (_m30) {
                console.error('Error loading data:', _m30);
                _q29(true);
            }
        };
        _h30();
    }, []);

    useEffect(() => {
        const _n30 = async () => {
            let _o30 = null;
            try {
                _o30 = localStorage.getItem('temp_secret_code');
                if (_o30) {
                    localStorage.removeItem('temp_secret_code');
                    if (window.chatbotStorage) {
                        await window.chatbotStorage.setSecretCode(_o30);
                    }
                } else if (window.chatbotStorage) {
                    _o30 = await window.chatbotStorage.getSecretCode();
                }

                if (_o30) {
                    console.log("Found saved secret code.");
                    _y29(_o30);
                    _a30(false);
                } else {
                    console.log("No secret code found. Redirecting to home");
                    window.location.href = '/';
                }
            } catch (_p30) {
                console.error('Error loading secret code:', _p30);
                window.location.href = '/';
            }
        };
        
        if (_p29) {
           _n30();
        } else {
            setTimeout(_n30, 200);
        }

    }, [_p29]);

    useEffect(() => {
        if (_p29 && _h29 && _h29.id) {
            window.chatbotStorage.setUserProfile(_h29);
        }
    }, [_h29, _p29]);

    useEffect(() => {
        if (_p29 && _j29) {
            window.chatbotStorage.setCharacters(_j29);
        }
    }, [_j29, _p29]);

    useEffect(() => {
        if (_p29 && _l29) {
            window.chatbotStorage.setGroups(_l29);
        }
    }, [_l29, _p29]);
    
    useEffect(() => {
        if (_p29 && _n29) {
            window.chatbotStorage.setUpdateCards(_n29);
        }
    }, [_n29, _p29]);

    useEffect(() => {
    }, [_x29]);

    const _q30 = async () => {
        if (!_x29 || !_v29) return;
        const _r30 = await window.chatbotStorage.getAllData(); 

        if (!_r30.userProfile) {
            console.log("Export skipped: User profile not found.");
            return;
        }
        
        console.log("🚀 Syncing data with Google Drive...");
        const _s30 = await googleDriveService.findOrCreateFolder('Virtual Tax Friend Data');
        if (!_s30) return;

        const _t30 = `TaxFriend_data.json`;
        const _u30 = await googleDriveService.findFileByName(_t30, _s30);

        if (_u30) {
            await googleDriveService.updateJsonFile(_u30, _r30);
        } else {
            await googleDriveService.uploadJsonFile(_t30, _r30, _s30);
        }
    };  

    const _v30 = async () => {
        console.log("📥 Checking for data to import...");
        const _w30 = await googleDriveService.findOrCreateFolder('Virtual Tax Friend Data');
        if (!_w30) return;

        const _x30 = `TaxFriend_data.json`;
        const _y30 = await googleDriveService.findFileByName(_x30, _w30);
        
        if (_y30) {
            const _z30 = await googleDriveService.getFileContent(_y30);
            
            if (_z30 && typeof _z30 === 'object') {
                console.log("✅ Data found on Drive, importing...");
                const _a31 = {
                    userProfile: _z30.userProfile || null,
                    characters: Array.isArray(_z30.characters) ? _z30.characters : [],
                    groups: Array.isArray(_z30.groups) ? _z30.groups : [],
                    updateCards: Array.isArray(_z30.updateCards) ? _z30.updateCards : []
                };
                
                await window.chatbotStorage.setAllData(_a31);
                
                if (_a31.userProfile) _i29(_a31.userProfile);
                _k29(_a31.characters);
                _m29(_a31.groups);
                _o29(_a31.updateCards);

                if (!sessionStorage.getItem('importAlertShown')) {
                    alert("Chat history and data imported from Google Drive!");
                    sessionStorage.setItem('importAlertShown', 'true');
                }
            } else {
                 console.warn("⚠️ Import skipped: Data from Drive was empty or corrupted.");
            }
        } else {
            console.log(`No previous data found on Drive.`);
        }
    };

    useEffect(() => {
        const _b31 = () => _w29(true);
        const _c31 = () => _w29(false);
        window.addEventListener('google-authed', _b31);
        window.addEventListener('google-signed-out', _c31);
        return () => {
            window.removeEventListener('google-authed', _b31);
            window.removeEventListener('google-signed-out', _c31);
        };
    }, []);
    
    useEffect(() => {
        if (_v29 && _x29) {
            console.log("Google Auth is active. Starting import and auto-export interval.");
            _v30();
            if (_f30.current) clearInterval(_f30.current);
            _f30.current = setInterval(_q30, 30000);
            return () => {
                if (_f30.current) clearInterval(_f30.current);
            };
        }
    }, [_v29, _x29]);

    useEffect(() => {
        const _d31 = () => {
            if (_g30.current) clearTimeout(_g30.current);
            _g30.current = setTimeout(() => {
                alert("You have been logged out due to inactivity.");
                _e31();
            }, 3600000);
        };
        if (_x29) {
            const _f31 = ['mousemove', 'keypress', 'click', 'scroll'];
            _f31.forEach(_g31 => window.addEventListener(_g31, _d31));
            _d31();
            return () => {
                _f31.forEach(_h31 => window.removeEventListener(_h31, _d31));
                if (_g30.current) clearTimeout(_g30.current);
            };
        }
    }, [_x29]);

    const _e31 = async () => {
        console.log("Logging out...");
        if (window.gapiAccessToken) {
            google.accounts.oauth2.revoke(window.gapiAccessToken.access_token);
            window.gapiAccessToken = null;
            if (window.chatbotStorage) await window.chatbotStorage.removeAuthToken();
            _w29(false);
        }
        _y29(null);
        if (window.chatbotStorage) await window.chatbotStorage.removeSecretCode();
        
        sessionStorage.removeItem('importAlertShown');
        if (_f30.current) clearInterval(_f30.current);
        if (_g30.current) clearTimeout(_g30.current);
        
        window.location.href = '/';
    };

    const _i31 = (_j31) => {
        _o29(_k31 => {
            const _l31 = _k31.some(_m31 => _m31.id === _j31.id);
            if (_l31) {
                return _k31.map(_n31 => _n31.id === _j31.id ? _j31 : _n31);
            } else {
                return [..._k31, _j31];
            }
        });
        _e30({ screen: 'updates-dashboard' });
    };

    const _o31 = (_p31) => {
        _o29(_q31 => _q31.filter(_r31 => _r31.id !== _p31));
    };

    if (!_p29 || _z29) {
        return (
            <div className="h-screen flex flex-col justify-center items-center bg-gray-100">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <h2 className="text-xl font-semibold text-gray-700">
                        {_z29 ? 'Authenticating...' : 'Loading Your CA...'}
                    </h2>
                    <div className="w-64 bg-gray-200 rounded-full h-2">
                        <div 
                            className="bg-blue-500 h-2 rounded-full transition-all" 
                            style={{ width: `${_r29}%` }}
                        ></div>
                    </div>
                </div>
            </div>
        );
    }

    if (!_h29.name) {
        return <UserProfileSetup userProfile={_h29} onSave={_i29} isInitialSetup={true} />;
    }
    
    const _s31 = () => {
        switch (_d30.screen) {
            case 'chats':
                return (
                    <CharacterList
                        characters={_j29}
                        groups={_l29}
                        onSelectCharacter={_t31 => _e30({ screen: 'chat-single', id: _t31 })}
                        onSelectGroup={_u31 => _e30({ screen: 'chat-group', id: _u31 })}
                        onNavigateToUpdates={() => _e30({ screen: 'updates-dashboard' })}
                        setCharacters={_k29}
                        setGroups={_m29}
                        setUserProfile={_i29}
                        setChatBackground={_u29}
                        userProfile={_h29}
                        chatBackground={_t29}
                        isGoogleAuthed={_v29}
                        onLogout={_e31}
                    />
                );
            case 'chat-single':
                const _v31 = _j29.find(_w31 => _w31.id === _d30.id);
                if (!_v31) {
                    _e30({ screen: 'chats' });
                    return null;
                }
                return (
                    <ChatScreen
                        character={_v31}
                        userProfile={_h29}
                        onCharacterUpdate={_x31 => _k29(_y31 => _y31.map(_z31 => _z31.id === _x31.id ? _x31 : _z31))}
                        onBack={() => _e30({ screen: 'chats' })}
                        onUserProfileUpdate={_i29}
                        backgroundUrl={_t29}
                        onSetBackground={_u29}
                    />
                );
            case 'chat-group':
                 const _a32 = _l29.find(_b32 => _b32.id === _d30.id);
                 if (!_a32) {
                    _e30({ screen: 'chats' });
                    return null;
                 }
                return (
                    <GroupChatScreen
                        group={_a32}
                        characters={_j29}
                        userProfile={_h29}
                        onGroupUpdate={_c32 => _m29(_d32 => _d32.map(_e32 => _e32.id === _c32.id ? _c32 : _e32))}
                        onBack={() => _e30({ screen: 'chats' })}
                        onUserProfileUpdate={_i29}
                        backgroundUrl={_t29}
                        onSetBackground={_u29}
                    />
                );
            case 'updates-dashboard':
                return (
                    <UpdatesDashboardScreen
                        cards={_n29}
                        onNavigateBack={() => _e30({ screen: 'chats' })}
                        onNavigateToForm={_f32 => _e30({ screen: 'updates-form', card: _f32 })}
                        onNavigateToView={_g32 => _e30({ screen: 'updates-view', card: _g32 })}
                        onCardUpdate={_i31}
                        onCardDelete={_o31}
                    />
                );
            case 'updates-form':
                return (
                    <CardForm
                        initialCard={_d30.card}
                        onSave={_i31}
                        onCancel={() => _e30({ screen: 'updates-dashboard' })}
                    />
                );
            case 'updates-view':
                 if (!_d30.card) {
                    _e30({ screen: 'updates-dashboard' });
                    return null;
                 }
                return (
                    <CardViewScreen
                        card={_d30.card}
                        onBack={() => _e30({ screen: 'updates-dashboard' })}
                    />
                );
            default:
                _e30({ screen: 'chats' });
                return null;
        }
    };

    return (
        <div className="app-container">
            {_b30 && (
                <DrivePromptModal 
                    onConnect={() => {
                        handleAuthClick();
                        _c30(false);
                    }}
                    onSkip={() => _c30(false)}
                />
            )}
            {_s31()}
        </div>
    );
};
// --- NAYA APP COMPONENT END ---


// --- RENDER ---
// Main Application Wrapper with Authentication

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);


    </script>
</body>
</html>
