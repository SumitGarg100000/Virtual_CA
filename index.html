<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Chartered Accountants - AI Tax & GST Expert</title>

    <meta name="description" content="Aapka personal Virtual Chartered Accountant. GST, Income Tax, finance, aur investments se jude sawaal puchein aur turant jawaab paayein.">
    <meta name="keywords" content="Virtual Chartered Accountant, CA Chatbot, GST Expert, Tax Consultant, Income Tax India, Financial Advisor">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="Virtual Chartered Accountants">
    <meta property="og:description" content="Aapka personal Virtual CA. GST, Income Tax, aur finance ke sawaal puchein.">
    <meta property="og:image" content="/whatsapp.png"> <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Virtual Chartered Accountant">
    <meta property="og:url" content="https://ca-app-eta.vercel.app"> <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/whatsapp.png"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KMZ77HZPFR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KMZ77HZPFR');
    </script>

    <script type="application/ld+json">
     {
       "@context": "https://schema.org",
       "@type": "SoftwareApplication",
       "name": "Virtual Chartered Accountants",
       "applicationCategory": "FinanceApplication",
       "operatingSystem": "Web",
       "description": "An AI-powered chatbot for Chartered Accountants in India to get expert advice on GST, Income Tax, and Auditing. Saves time by analyzing documents and providing real-time updates.",
       "developer": { "@type": "Person", "name": "Sumit Garg" },
       "offers": { "@type": "Offer", "price": "0" }
     }
     </script>

    <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <script src="/js/indexeddb-utils.js"></script> <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script>

    <script>
        // Apni Keys yahan paste karein
        const GOOGLE_CLIENT_ID = '552980243748-g02kbg67f1r8ortovgh7ia975f46a8i6.apps.googleusercontent.com';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let gapiAccessToken = null; // Global token storage

        // Jab GAPI script load ho
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Jab GIS script load ho
        function gisLoaded() {
            try {
                 tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive',
                    callback: '', // Callback set dynamically
                });
                gisInited = true;
                console.log("âœ… Google Identity Services (GIS) Initialized!");
                checkAndSignalReady();
             } catch (error) {
                console.error("Error initializing GIS:", error);
             }
        }

        // GAPI client ko initialize karna
        async function initializeGapiClient() {
             try {
                await gapi.client.init({
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                gapiInited = true;
                console.log("âœ… Google API Client Initialized!");
                // Check if token already exists from previous session (load from IndexedDB)
                await loadExistingToken();
                checkAndSignalReady();
            } catch(error){
               console.error("Error initializing GAPI client:", error);
            }
        }

        // Check if both libraries are ready
        function checkAndSignalReady() {
            if (gapiInited && gisInited) {
                console.log("ðŸš€ Both Google libraries are ready!");
                window.dispatchEvent(new CustomEvent('gapi-ready'));
            }
        }

         // Load existing token from IndexedDB
        async function loadExistingToken() {
            try {
                 // Ensure chatbotStorage is initialized before using it
                if (window.chatbotStorage) {
                    gapiAccessToken = await window.chatbotStorage.getAuthToken();
                    if (gapiAccessToken) {
                        console.log("ðŸ”‘ Found existing Google Auth Token in IndexedDB.");
                        gapi.client.setToken(gapiAccessToken);
                        console.log("ðŸš€ Existing token has been set in GAPI client.");
                        window.dispatchEvent(new CustomEvent('google-authed')); // Signal that user is authenticated
                    } else {
                         console.log("No existing token found in IndexedDB.");
                    }
                } else {
                    console.warn("chatbotStorage not ready yet for loading token.");
                    // Retry after a short delay if needed
                    setTimeout(loadExistingToken, 500);
                }
            } catch (error) {
                console.error("Error loading auth token:", error);
            }
        }

        // Login/Logout handler
        function handleAuthClick() {
             if (!tokenClient) {
                 console.error("GIS Token Client not initialized!");
                 alert("Google Sign-In is not ready yet. Please wait a moment and try again.");
                 return;
             }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Google Auth Error:", resp);
                    // Maybe dispatch an event for React to show an error
                    window.dispatchEvent(new CustomEvent('google-auth-error', { detail: resp.error }));
                    return; // Stop further processing on error
                }
                gapiAccessToken = resp;
                gapi.client.setToken(gapiAccessToken);

                if (window.chatbotStorage) {
                    await window.chatbotStorage.setAuthToken(gapiAccessToken);
                }
                console.log("âœ… Google Sign-In Successful! Token saved and set in GAPI client.");
                window.dispatchEvent(new CustomEvent('google-authed'));
            };

            if (gapiAccessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                google.accounts.oauth2.revoke(gapiAccessToken.access_token, async () => {
                     console.log("ðŸ”Œ Google Sign-Out Successful! Token revoked.");
                     gapiAccessToken = null;
                     gapi.client.setToken(null);
                     if (window.chatbotStorage) {
                         await window.chatbotStorage.removeAuthToken(); // Remove from IndexedDB
                     }
                     console.log("Token removed from IndexedDB.");
                     window.dispatchEvent(new CustomEvent('google-signed-out'));
                });

            }
        }

        // Helper for Drive operations (moved here from app.html)
        const googleDriveService = {
             async findOrCreateFolder(folderName, parentId = null) {
                const parentQuery = parentId ? `'${parentId}' in parents` : "'root' in parents";
                try {
                    // Ensure GAPI client is ready and authenticated
                     if (!gapi.client?.drive?.files) {
                        console.error("GAPI Drive client not ready.");
                        await new Promise(resolve => setTimeout(resolve, 500)); // Wait and retry
                         if (!gapi.client?.drive?.files) throw new Error("GAPI Drive client failed to initialize.");
                     }
                     if (!gapi.client.getToken()) {
                        console.warn("Not authenticated for Drive operation.");
                        // Optionally trigger authentication here if needed
                         // handleAuthClick(); // Be careful with triggering UI from here
                         return null; // Or throw error
                     }

                    const response = await gapi.client.drive.files.list({
                        q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and ${parentQuery} and trashed=false`,
                        fields: 'files(id, name)',
                    });
                    if (response.result.files.length > 0) {
                        console.log(`Folder '${folderName}' found with ID: ${response.result.files[0].id}`);
                        return response.result.files[0].id;
                    } else {
                        console.log(`Folder '${folderName}' not found, creating new one...`);
                        const fileMetadata = { name: folderName, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : ['root'] };
                        const newFolderResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                        console.log(`Folder created with ID: ${newFolderResponse.result.id}`);
                        return newFolderResponse.result.id;
                    }
                } catch (error) {
                    console.error("Error finding or creating folder:", error);
                    let errorMessage = "An unknown error occurred. Check console for details.";
                    if (error && error.body) { try { const errorDetails = JSON.parse(error.body); if (errorDetails.error && errorDetails.error.message) { errorMessage = errorDetails.error.message; } } catch (e) { errorMessage = "Could not read the exact error message from Google."; } }
                     // Alerting here might be disruptive, consider logging or updating UI state via events
                     // alert("Google Drive Error: " + errorMessage);
                     window.dispatchEvent(new CustomEvent('google-drive-error', { detail: errorMessage }));
                    return null;
                }
            },
            async findFileByName(fileName, parentId) {
                 try {
                      if (!gapi.client?.drive?.files || !gapi.client.getToken()) {
                        console.warn("Drive client not ready or not authenticated for findFileByName.");
                         return null;
                     }
                    const response = await gapi.client.drive.files.list({
                        q: `name='${fileName}' and '${parentId}' in parents and trashed=false`,
                        fields: 'files(id, name)',
                        pageSize: 1
                    });
                    return response.result.files.length > 0 ? response.result.files[0].id : null;
                } catch (error) { console.error("Error finding file:", error); return null; }
            },
            async updateJsonFile(fileId, jsonData) {
                 try {
                     const token = gapi.client.getToken();
                     if (!token) { console.error("Authentication token not found!"); return null; }
                     const accessToken = token.access_token;
                     const fileContent = JSON.stringify(jsonData, null, 2);

                    const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    });
                    if (!response.ok) {
                        const errorResponse = await response.json(); throw new Error(JSON.stringify(errorResponse));
                    }
                    const result = await response.json();
                    console.log(`File with ID ${fileId} updated successfully via fetch.`);
                    return result.id;
                } catch (error) {
                     console.error("Error updating file with fetch:", error);
                     // alert("Google Drive UPDATE Error: " + error.message);
                     window.dispatchEvent(new CustomEvent('google-drive-error', { detail: "Update Error: " + error.message }));
                     return null;
                 }
            },
            async uploadJsonFile(fileName, jsonData, parentId) {
                 try {
                    const token = gapi.client.getToken();
                     if (!token) { console.error("Authentication token not found!"); return null; }
                     const accessToken = token.access_token;
                     const fileContent = JSON.stringify(jsonData, null, 2);
                     const metadata = { name: fileName, parents: [parentId] };
                     const boundary = '-------314159265358979323846';
                     const delimiter = `\r\n--${boundary}\r\n`;
                     const close_delim = `\r\n--${boundary}--`;
                     const multipartRequestBody =
                        delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata) +
                        delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': `multipart/related; boundary=${boundary}`
                        },
                        body: multipartRequestBody
                    });
                    if (!response.ok) {
                        const errorResponse = await response.json(); throw new Error(JSON.stringify(errorResponse));
                    }
                    const result = await response.json();
                    console.log(`File '${fileName}' uploaded successfully with ID: ${result.id}`);
                    return result.id;
                } catch (error) {
                     console.error("Error uploading file with fetch:", error);
                     // alert("Google Drive UPLOAD Error: " + error.message);
                     window.dispatchEvent(new CustomEvent('google-drive-error', { detail: "Upload Error: " + error.message }));
                     return null;
                 }
             },
             async getFileContent(fileId) {
                 try {
                      if (!gapi.client?.drive?.files || !gapi.client.getToken()) {
                        console.warn("Drive client not ready or not authenticated for getFileContent.");
                         return null;
                     }
                    const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                    // Drive API returns the content directly in response.body for alt=media,
                    // but gapi.client wraps it in response.result
                    // Check if response.result exists and is the expected type
                    if (typeof response.result === 'object') {
                         return response.result;
                    } else {
                        // If not an object, maybe it's raw text? Try parsing.
                        try { return JSON.parse(response.body); } catch(e) { return response.body; } // Fallback to raw body
                    }
                 } catch (error) {
                     console.error("Error getting file content:", error);
                     window.dispatchEvent(new CustomEvent('google-drive-error', { detail: "Get Content Error: " + (error.result?.error?.message || error.message) }));
                     return null;
                 }
            }
        };
    </script>

  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
